<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS Booking Chart Defragmenter - Discovery Holiday Parks</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/dhp_circle_logo.svg">
    <link rel="icon" type="image/png" href="/static/images/dhp_circle_logo.svg">
    <link rel="shortcut icon" href="/static/images/dhp_circle_logo.svg">
    <!-- Cache buster: v1.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/styles/theme.css" rel="stylesheet">
    <style>
        .move-card {
            transition: transform 0.2s;
        }
        .move-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-pending { border-left: 4px solid #ffc107; }
        .status-approved { border-left: 4px solid #28a745; }
        .status-rejected { border-left: 4px solid #dc3545; }
        .status-applied { border-left: 4px solid #17a2b8; }
        .debug-output-container {
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-output {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #ffffff;
        }

        .debug-line {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .debug-line .timestamp {
            color: #888888;
            margin-right: 8px;
        }

        .debug-line .step {
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }

        .debug-line .message {
            color: #ffffff;
        }

        .debug-line .error {
            color: #f44336;
        }

        .debug-line .success {
            color: #4CAF50;
        }

        .debug-line .warning {
            color: #ff9800;
        }

        .debug-line .info {
            color: #2196F3;
        }

        .progress {
            background-color: #e9ecef;
        }

        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Discovery Holiday Parks Theme */
        .navbar-dhp {
            background: linear-gradient(135deg, #1e6091 0%, #2e8b9b 100%) !important;
            border-bottom: 3px solid #00a650;
        }
        
        .btn-dhp-primary {
            background: linear-gradient(135deg, #00a650 0%, #2e8b9b 100%);
            border: none;
            color: white;
        }
        
        .btn-dhp-primary:hover {
            background: linear-gradient(135deg, #008a43 0%, #266f7a 100%);
            color: white;
        }
        
        .table-dhp thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .dhp-logo {
            height: 32px;
            width: auto;
            margin-right: 10px;
        }
        
        .badge-dhp-high {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .badge-dhp-medium {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }
        
        .badge-dhp-low {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .card-dhp {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card-dhp .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #00a650;
        }
        
        /* DHP Tab Styling */
        .nav-tabs-dhp {
            border-bottom: 2px solid #00a650;
        }
        
        .nav-link-dhp {
            color: #1e6091;
            border: 1px solid transparent;
            border-bottom: none;
        }
        
        .nav-link-dhp:hover {
            color: #00a650;
            border-color: #00a650 #00a650 transparent;
        }
        
        .nav-link-dhp.active {
            color: #fff !important;
            background: linear-gradient(135deg, #1e6091 0%, #2e8b9b 100%);
            border-color: #00a650 #00a650 transparent;
        }
        
        .definitions-section-header {
            color: #1e6091;
            border-bottom: 2px solid #00a650;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
    </style>
    <meta name="use-training-db" content="{{ 'true' if use_training_db else 'false' }}">
</head>
<body>
    {% set active_page = 'dashboard' %}
    {% include 'components/header.html' %}

    <div class="container-fluid container-fluid-edge mt-4">
        <!-- Login Form -->
        <div class="row justify-content-center" id="login-section">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>Login</h5>
                    </div>
                    <div class="card-body">
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username-input" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username-input" required>
                            </div>
                            <div class="mb-3">
                                <label for="password-input" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-1"></i>Login
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div class="d-none" id="main-app">
            <div class="row">
                <div class="col-md-3 sidebar-narrow">
                    <!-- Admin Setup Link -->
                    <div class="card card-dhp mb-3 d-none" id="admin-setup-card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Admin Setup</h6>
                        </div>
                        <div class="card-body">
                            <a href="/setup" class="btn btn-outline-primary btn-sm w-100 mb-2">
                                <i class="fas fa-cogs me-1"></i>System Setup
                            </a>
                            <div class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                Properties & Database Management
                            </div>
                        </div>
                    </div>
                    
                    <!-- Defragmentation Analysis Section -->
                    <div class="card card-dhp mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Defragmentation Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Property</label>
                                <select class="form-select" id="property-filter">
                                    <option value="">Select Property</option>
                                    <!-- Properties will be populated dynamically -->
                                </select>
                            </div>
                            <!-- Status filter removed as it is not used for defragmentation analysis -->
                            <div class="mb-3">
                                <label class="form-label">Move Suggestions</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-dhp-primary btn-sm" id="load-moves-btn" onclick="loadMoveSuggestions()">
                                        <i class="fas fa-download me-1"></i>Load Move Suggestions
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" id="refresh-moves-btn" onclick="refreshMoveSuggestions()" style="display: none;">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh Move Suggestions
                                    </button>
                                </div>
                                <div class="form-text small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Generate fresh move suggestions from live RMS data.
                                </div>
                            </div>
                            <!-- Removed Refresh Display button (redundant) -->
                        </div>
                    </div>
                    
                    <!-- History Section -->
                    <div class="card card-dhp mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i>History</h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-info btn-sm w-100" onclick="showMoveHistory()">
                                <i class="fas fa-history me-1"></i>View Move History
                            </button>
                            <div class="form-text small mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                View past defragmentation activities and decisions.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Definitions Section -->
                    <div class="card card-dhp mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-book me-2"></i>Definitions</h6>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="showDefinitions()">
                                <i class="fas fa-info-circle me-1"></i>Algorithm Explanations
                            </button>
                            <div class="form-text small mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                Understand how suggestions, importance, and freed nights are calculated.
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-9 content-wide">
                    <!-- Move Suggestions Display -->
                    <div class="card card-dhp">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-exchange-alt me-2"></i>
                                Defragmentation Moves
                                <span id="cache-status" class="badge bg-secondary ms-2">No data loaded</span>
                            </h6>
                            
                        </div>
                        <div class="card-body">
                            <!-- Move Actions Bar -->
                            <div id="move-actions-bar" class="mb-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="text-muted">Selected: </span>
                                        <span id="selected-count" class="badge bg-primary">0</span>
                                        <span class="text-muted ms-2">moves</span>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-success btn-sm" onclick="processSelectedMoves()" id="process-btn" disabled>
                                            <i class="fas fa-check me-1"></i>Process Selected
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                            <i class="fas fa-times me-1"></i>Clear Selection
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="moves-container">
                                <p class="text-muted text-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Select a property and click "Load Move Suggestions" to begin
                                </p>
                            </div>
                            

                        </div>
                    </div>
                    
                    <!-- RMS API Debug Panel -->
                    <div id="rms-debug-panel" class="card mt-3" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-terminal me-2"></i>
                                RMS API Progress
                                <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#debug-collapse" aria-expanded="false" aria-controls="debug-collapse">
                                    <i class="fas fa-chevron-down" id="debug-toggle-icon"></i>
                                </button>
                            </h6>
                            <div>
                                <span id="rms-status-badge" class="badge bg-secondary">Disconnected</span>
                                <button type="button" class="btn-close" onclick="closeRmsDebugPanel()" aria-label="Close"></button>
                            </div>
                        </div>
                        
                        <!-- Always visible progress bar -->
                        <div class="card-body pb-2">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small id="rms-progress-text">Initializing...</small>
                                    <small id="rms-progress-percentage">0%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div id="rms-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Collapsible debug output -->
                        <div class="collapse" id="debug-collapse">
                            <div class="card-body pt-0">
                                <!-- Debug Output -->
                                <div class="debug-output-container">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Debug Output</small>
                                    </div>
                                    <div id="rms-debug-output" class="debug-output">
                                        <div class="debug-line">
                                            <span class="timestamp">[Ready]</span>
                                            <span class="message">Ready to connect to RMS API...</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Auto-managed connection - no manual controls needed -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'components/footer.html' %}

               <!-- Move Details Modal -->
           <div class="modal fade" id="moveModal" tabindex="-1">
               <div class="modal-dialog modal-lg">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">Move Details</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body" id="move-modal-content">
                           <!-- Content will be populated dynamically -->
                       </div>
                       <div class="modal-footer" id="move-modal-actions">
                           <!-- Actions will be populated dynamically -->
                       </div>
                   </div>
               </div>
           </div>

           <!-- Definitions Modal -->
           <div class="modal fade" id="definitionsModal" tabindex="-1">
               <div class="modal-dialog modal-xl">
                   <div class="modal-content">
                       <div class="modal-header navbar-dhp text-white">
                           <h5 class="modal-title">
                               <i class="fas fa-book me-2"></i>
                               Defragmentation Algorithm Definitions
                           </h5>
                           <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body">
                           <div class="row">
                               <div class="col-md-12">
                                   <nav>
                                       <div class="nav nav-tabs nav-tabs-dhp" id="nav-tab" role="tablist">
                                           <button class="nav-link nav-link-dhp active" id="nav-overview-tab" data-bs-toggle="tab" data-bs-target="#nav-overview" type="button" role="tab">
                                               <i class="fas fa-eye me-1"></i>Overview
                                           </button>
                                           <button class="nav-link nav-link-dhp" id="nav-suggestions-tab" data-bs-toggle="tab" data-bs-target="#nav-suggestions" type="button" role="tab">
                                               <i class="fas fa-exchange-alt me-1"></i>Move Suggestions
                                           </button>
                                           <button class="nav-link nav-link-dhp" id="nav-importance-tab" data-bs-toggle="tab" data-bs-target="#nav-importance" type="button" role="tab">
                                               <i class="fas fa-star me-1"></i>Strategic Importance
                                           </button>
                                           <button class="nav-link nav-link-dhp" id="nav-freed-nights-tab" data-bs-toggle="tab" data-bs-target="#nav-freed-nights" type="button" role="tab">
                                               <i class="fas fa-moon me-1"></i>Freed Nights
                                           </button>
                                           <button class="nav-link nav-link-dhp" id="nav-filtering-tab" data-bs-toggle="tab" data-bs-target="#nav-filtering" type="button" role="tab">
                                               <i class="fas fa-filter me-1"></i>Constraints & Filtering
                                           </button>
                                       </div>
                                   </nav>
                                   <div class="tab-content mt-3" id="nav-tabContent">
                                       <!-- Overview Tab -->
                                       <div class="tab-pane fade show active" id="nav-overview" role="tabpanel">
                                           <h6 class="definitions-section-header"><i class="fas fa-info-circle me-2"></i>System Overview</h6>
                                           <p>The RMS Booking Chart Defragmenter analyzes reservation patterns to identify opportunities for improving contiguous availability within accommodation categories. The system prioritizes moves that create longer, uninterrupted blocks of availability, which are more valuable for future bookings.</p>
                                           
                                           <div class="alert alert-info">
                                               <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Core Principle</h6>
                                               <p class="mb-0">Longer contiguous stays are exponentially more valuable than scattered single-night bookings. The system scores moves based on their ability to consolidate availability into meaningful blocks.</p>
                                           </div>
                                           
                                           <h6 class="definitions-section-header mt-3"><i class="fas fa-cogs me-2"></i>Analysis Process</h6>
                                           <ol>
                                               <li><strong>Build Occupancy Matrix:</strong> Map all reservations across units and dates</li>
                                               <li><strong>Calculate Category Strategic Importance:</strong> Assess fragmentation levels for each accommodation type</li>
                                               <li><strong>Identify Moveable Reservations:</strong> Find non-fixed reservations within the analysis period</li>
                                               <li><strong>Evaluate Move Options:</strong> Test each reservation against available units in the same category</li>
                                               <li><strong>Score Improvements:</strong> Calculate fragmentation reduction for each potential move</li>
                                               <li><strong>Generate Suggestions:</strong> Rank and present the most beneficial moves</li>
                                           </ol>
                                       </div>
                                       
                                       <!-- Move Suggestions Tab -->
                                       <div class="tab-pane fade" id="nav-suggestions" role="tabpanel">
                                           <h6 class="definitions-section-header"><i class="fas fa-exchange-alt me-2"></i>Move Suggestion Algorithm</h6>
                                           
                                           <h6 class="mt-3">Eligibility Criteria</h6>
                                           <p>A reservation is eligible for moving if it meets all of the following:</p>
                                           <ul>
                                               <li><strong>Confirmed or Unconfirmed Status:</strong> Only reservations with "Confirmed" or "Unconfirmed" status are considered for moves</li>
                                               <li><strong>Not Fixed:</strong> Reservation is not marked as "fixed" in RMS</li>
                                               <li><strong>Within Analysis Period:</strong> Entire stay falls within the constraint date range</li>
                                               <li><strong>Valid Category:</strong> Belongs to a category with multiple units available</li>
                                               <li><strong>No Conflicts:</strong> Target unit is completely available for the entire stay period</li>
                                           </ul>
                                           
                                           <div class="alert alert-warning mt-3">
                                               <h6 class="alert-heading"><i class="fas fa-shield-alt me-2"></i>Protected Reservation Types</h6>
                                               <p class="mb-2">The following reservation types are <strong>automatically excluded</strong> from move suggestions:</p>
                                               <ul class="mb-0">
                                                   <li><strong>Pencil Bookings:</strong> Tentative reservations not confirmed</li>
                                                   <li><strong>Maintenance/Out of Order:</strong> Units under maintenance or repair</li>
                                                   <li><strong>Departed:</strong> Completed stays</li>
                                                   <li><strong>Arrived:</strong> Current active stays</li>
                                                   <li><strong>Owner Occupied:</strong> Owner usage periods</li>
                                                   <li><strong>Quote:</strong> Price quotations not yet confirmed</li>
                                               </ul>
                                           </div>
                                           
                                           <h6 class="mt-3">Improvement Calculation</h6>
                                           <div class="bg-light p-3 rounded">
                                               <code>
                                               improvement = new_fragmentation_score - current_fragmentation_score<br/>
                                               where lower fragmentation_score = better consolidation
                                               </code>
                                           </div>
                                           
                                           <h6 class="mt-3">Fragmentation Scoring</h6>
                                           <p>The system uses a sophisticated scoring mechanism:</p>
                                           <ul>
                                               <li><strong>Contiguous Block Scoring:</strong> Longer availability periods get exponentially higher scores (quadratic scoring)</li>
                                               <li><strong>Gap Penalty:</strong> Multiple small gaps are penalized more heavily than single large gaps</li>
                                               <li><strong>Strategic Bonus:</strong> Moves that create strategically valuable periods receive bonus points</li>
                                           </ul>
                                           
                                           <div class="alert alert-warning">
                                               <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Sequential Processing</h6>
                                               <p class="mb-0">Moves are processed sequentially because later moves depend on earlier ones. Each move affects the occupancy matrix and changes subsequent opportunities.</p>
                                           </div>
                                       </div>
                                       
                                       <!-- Strategic Importance Tab -->
                                       <div class="tab-pane fade" id="nav-importance" role="tabpanel">
                                           <h6 class="definitions-section-header"><i class="fas fa-star me-2"></i>Strategic Importance Calculation</h6>
                                           
                                           <p>Strategic importance combines <strong>category-level strategic analysis</strong> with <strong>individual move improvement scores</strong> to prioritize the most valuable moves.</p>
                                           
                                           <h6 class="mt-3">Category Strategic Importance Factors</h6>
                                           
                                           <div class="row">
                                               <div class="col-md-6">
                                                   <div class="card">
                                                       <div class="card-header bg-success text-white">
                                                           <h6 class="mb-0">Primary Check: Sufficient Availability</h6>
                                                       </div>
                                                       <div class="card-body">
                                                           <p>If <strong>70%+ of dates</strong> have <strong>3+ units available</strong>, the category gets <span class="badge bg-success">Strategic Importance = 0</span></p>
                                                           <small class="text-muted">This prevents unnecessary moves in already well-distributed categories.</small>
                                                       </div>
                                                   </div>
                                               </div>
                                               <div class="col-md-6">
                                                   <div class="card">
                                                       <div class="card-header bg-warning text-dark">
                                                           <h6 class="mb-0">Fragmentation Analysis</h6>
                                                       </div>
                                                       <div class="card-body">
                                                           <p>For categories needing improvement:</p>
                                                           <ul class="small">
                                                               <li><strong>Contiguous Length Factor (50%):</strong> Shorter periods need consolidation</li>
                                                               <li><strong>Fragmentation Factor (30%):</strong> More gaps = higher importance</li>
                                                               <li><strong>Density Factor (20%):</strong> Lower availability = higher importance</li>
                                                           </ul>
                                                       </div>
                                                   </div>
                                               </div>
                                           </div>
                                           
                                           <h6 class="mt-3">Combined Scoring Formula</h6>
                                           <div class="bg-light p-3 rounded">
                                               <code>
                                               combined_score = improvement_score × (1 + category_strategic_score)<br/><br/>
                                               
                                               if (combined_score ≥ 0.6 OR category_strategic_score ≥ 0.7):<br/>
                                               &nbsp;&nbsp;&nbsp;&nbsp;importance = "High"<br/>
                                               elif (combined_score ≥ 0.3 OR category_strategic_score ≥ 0.4):<br/>
                                               &nbsp;&nbsp;&nbsp;&nbsp;importance = "Medium"<br/>
                                               else:<br/>
                                               &nbsp;&nbsp;&nbsp;&nbsp;importance = "Low"
                                               </code>
                                           </div>
                                       </div>
                                       
                                       <!-- Freed Nights Tab -->
                                       <div class="tab-pane fade" id="nav-freed-nights" role="tabpanel">
                                           <h6 class="definitions-section-header"><i class="fas fa-moon me-2"></i>Freed Nights Calculation</h6>
                                           
                                           <p>Freed nights represent the <strong>maximum contiguous period</strong> that becomes available in the original unit when a reservation is moved.</p>
                                           
                                           <h6 class="mt-3">Calculation Process</h6>
                                           <ol>
                                               <li><strong>Temporarily Remove Reservation:</strong> Simulate removing the reservation from its current unit</li>
                                               <li><strong>Find Contiguous Periods:</strong> Identify all continuous availability blocks in the freed unit</li>
                                               <li><strong>Match Freed Dates:</strong> Find which contiguous period includes the dates freed by the move</li>
                                               <li><strong>Return Maximum Length:</strong> Report the length of the longest contiguous period that includes the freed dates</li>
                                           </ol>
                                           
                                           <div class="alert alert-info">
                                               <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Example</h6>
                                               <p>If moving a 2-night reservation creates a 5-night contiguous block, the "Freed Nights" value is <strong>5</strong>, not 2. This shows the total value of the consolidation.</p>
                                           </div>
                                           
                                           <h6 class="mt-3">Why This Matters</h6>
                                           <ul>
                                               <li><strong>Revenue Impact:</strong> Longer contiguous blocks can accommodate longer stays</li>
                                               <li><strong>Booking Flexibility:</strong> More options for future reservations</li>
                                               <li><strong>Operational Efficiency:</strong> Reduces housekeeping and maintenance complexity</li>
                                           </ul>
                                           
                                           <div class="bg-light p-3 rounded">
                                               <h6>Freed Nights vs. Reservation Length</h6>
                                               <p class="mb-0"><strong>Reservation Length:</strong> How many nights the guest is staying<br/>
                                               <strong>Freed Nights:</strong> How many contiguous nights become available through the move</p>
                                           </div>
                                       </div>
                                       
                                       <!-- Constraints & Filtering Tab -->
                                       <div class="tab-pane fade" id="nav-filtering" role="tabpanel">
                                           <h6 class="definitions-section-header"><i class="fas fa-filter me-2"></i>Constraints & Filtering Logic</h6>
                                           
                                           <h6 class="mt-3">Analysis Period Constraints</h6>
                                           <ul>
                                               <li><strong>Constraint Start Date:</strong> Moves only consider reservations that begin on or after this date</li>
                                               <li><strong>Constraint End Date:</strong> Moves only consider reservations that end on or before this date</li>
                                               <li><strong>Partial Overlap:</strong> Reservations that extend beyond the constraint period are excluded</li>
                                           </ul>
                                           
                                           <h6 class="mt-3">Status-Based Filtering</h6>
                                           <div class="row">
                                               <div class="col-md-6">
                                                   <div class="alert alert-success">
                                                       <h6 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Eligible Status Types</h6>
                                                       <p class="mb-1">Only these reservation statuses are considered for moves:</p>
                                                       <ul class="mb-0 small">
                                                           <li><strong>Confirmed:</strong> Finalized bookings</li>
                                                           <li><strong>Unconfirmed:</strong> Provisional bookings awaiting confirmation</li>
                                                       </ul>
                                                   </div>
                                               </div>
                                               <div class="col-md-6">
                                                   <div class="alert alert-danger">
                                                       <h6 class="alert-heading"><i class="fas fa-ban me-2"></i>Protected Status Types</h6>
                                                       <p class="mb-1">These reservation types are <strong>never moved:</strong></p>
                                                       <ul class="mb-0 small">
                                                           <li><strong>Pencil:</strong> Tentative/hold bookings</li>
                                                           <li><strong>Maintenance:</strong> Units under maintenance</li>
                                                           <li><strong>Arrived:</strong> Current guests</li>
                                                           <li><strong>Departed:</strong> Completed stays</li>
                                                           <li><strong>Owner Occupied:</strong> Owner usage</li>
                                                           <li><strong>Quote:</strong> Price quotations</li>
                                                       </ul>
                                                   </div>
                                               </div>
                                           </div>
                                           
                                           <h6 class="mt-3">Fixed Reservation Handling</h6>
                                           <div class="alert alert-warning">
                                               <h6 class="alert-heading"><i class="fas fa-lock me-2"></i>Fixed Reservations</h6>
                                               <p class="mb-0">Reservations marked as "fixed" in RMS are never suggested for moves. This protects special arrangements, VIP bookings, or reservations with specific unit requirements.</p>
                                           </div>
                                           
                                           <h6 class="mt-3">Category Validation</h6>
                                           <ul>
                                               <li><strong>Same Category Only:</strong> Reservations can only be moved within their accommodation category</li>
                                               <li><strong>Unit Availability:</strong> Target unit must be completely available for the entire stay</li>
                                               <li><strong>Multi-Unit Categories:</strong> Single-unit categories are excluded from analysis</li>
                                           </ul>
                                           
                                           <h6 class="mt-3">Improvement Threshold</h6>
                                           <p>Only moves that demonstrably improve the overall fragmentation score are suggested. Moves that would worsen fragmentation or provide no benefit are automatically filtered out.</p>
                                           
                                           <h6 class="mt-3">Sequential Dependencies</h6>
                                           <div class="bg-light p-3 rounded">
                                               <p class="mb-0"><strong>Order Matters:</strong> The system processes categories and moves in order of strategic importance. Earlier moves can affect the viability and value of later moves, ensuring realistic implementation scenarios.</p>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                       <div class="modal-footer bg-light border-top" style="border-top: 2px solid #00a650 !important;">
                           <button type="button" class="btn btn-dhp-primary" data-bs-dismiss="modal">
                               <i class="fas fa-times me-1"></i>Close
                           </button>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Profile Edit Modal -->
           <div class="modal fade" id="profileModal" tabindex="-1">
               <div class="modal-dialog">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">Edit Profile</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body">
                           <form id="profile-form">
                               <div class="mb-3">
                                   <label for="profile-email" class="form-label">Email</label>
                                   <input type="email" class="form-control" id="profile-email" required>
                               </div>
                               <div class="mb-3">
                                   <label for="profile-first-name" class="form-label">First Name</label>
                                   <input type="text" class="form-control" id="profile-first-name">
                               </div>
                               <div class="mb-3">
                                   <label for="profile-last-name" class="form-label">Last Name</label>
                                   <input type="text" class="form-control" id="profile-last-name">
                               </div>
                           </form>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Password Change Modal -->
           <div class="modal fade" id="passwordModal" tabindex="-1">
               <div class="modal-dialog">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">Change Password</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body">
                           <form id="password-form">
                               <div class="mb-3">
                                   <label for="current-password" class="form-label">Current Password</label>
                                   <input type="password" class="form-control" id="current-password" required>
                               </div>
                               <div class="mb-3">
                                   <label for="new-password" class="form-label">New Password</label>
                                   <input type="password" class="form-control" id="new-password" required>
                                   <div class="form-text">
                                       Password must be at least 12 characters with uppercase, lowercase, digits, and special characters.
                                   </div>
                               </div>
                               <div class="mb-3">
                                   <label for="confirm-password" class="form-label">Confirm New Password</label>
                                   <input type="password" class="form-control" id="confirm-password" required>
                               </div>
                           </form>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="button" class="btn btn-primary" onclick="changePassword()">Change Password</button>
                       </div>
                   </div>
               </div>
           </div>

           <!-- User Management Modal -->
           <div class="modal fade" id="userManagementModal" tabindex="-1">
               <div class="modal-dialog modal-xl">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">User Management</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body">
                           <div class="d-flex justify-content-between align-items-center mb-3">
                               <h6>Users</h6>
                               <button class="btn btn-primary btn-sm" onclick="showCreateUser()">
                                   <i class="fas fa-plus me-1"></i>Create User
                               </button>
                           </div>
                           <div id="users-list">
                               <!-- Users will be populated dynamically -->
                           </div>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Create User Modal -->
           <div class="modal fade" id="createUserModal" tabindex="-1">
               <div class="modal-dialog">
                   <div class="modal-content">
                       <div class="modal-header">
                           <h5 class="modal-title">Create New User</h5>
                           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                       </div>
                       <div class="modal-body">
                           <form id="create-user-form">
                               <div class="mb-3">
                                   <label for="create-username" class="form-label">Username</label>
                                   <input type="text" class="form-control" id="create-username" required>
                               </div>
                               <div class="mb-3">
                                   <label for="create-email" class="form-label">Email</label>
                                   <input type="email" class="form-control" id="create-email" required>
                               </div>
                               <div class="mb-3">
                                   <label for="create-password" class="form-label">Password</label>
                                   <input type="password" class="form-control" id="create-password" required>
                                   <div class="form-text">
                                       Password must be at least 12 characters with uppercase, lowercase, digits, and special characters.
                                   </div>
                               </div>
                               <div class="mb-3">
                                   <label for="create-first-name" class="form-label">First Name</label>
                                   <input type="text" class="form-control" id="create-first-name">
                               </div>
                               <div class="mb-3">
                                   <label for="create-last-name" class="form-label">Last Name</label>
                                   <input type="text" class="form-control" id="create-last-name">
                               </div>
                               <div class="mb-3">
                                   <div class="form-check">
                                       <input class="form-check-input" type="checkbox" id="create-is-admin">
                                       <label class="form-check-label" for="create-is-admin">
                                           Admin User
                                       </label>
                                   </div>
                               </div>
                               <div class="mb-3">
                                   <label class="form-label">Assign Properties</label>
                                   <div id="create-user-properties-list">
                                       <div class="text-muted small">Loading properties...</div>
                                   </div>
                                   <div class="mt-2">
                                       <button type="button" class="btn btn-outline-primary btn-sm" onclick="addPropertyToCreateUser()">
                                           <i class="fas fa-plus me-1"></i>Add Property
                                       </button>
                                   </div>
                               </div>
                           </form>
                       </div>
                       <div class="modal-footer">
                           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                           <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
                       </div>
                   </div>
               </div>
           </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // VERSION CHECK - Cache buster v1.2
        
        let currentUser = null;
        let authToken = null;
        
        // Session management
        let logoutTimer = null;
        let countdownTimer = null;
        const SESSION_TIMEOUT_MINUTES = 30; // Back to 30 minutes for production
        const SESSION_TIMEOUT_MS = SESSION_TIMEOUT_MINUTES * 60 * 1000;
        
        // Start automatic logout timer
        function startSessionTimer() {
            
            // Clear any existing timers
            if (logoutTimer) clearTimeout(logoutTimer);
            if (countdownTimer) clearInterval(countdownTimer);
            
            // Set the logout timer
            const loginTime = Date.now();
            const expiryTime = loginTime + SESSION_TIMEOUT_MS;
            
            logoutTimer = setTimeout(() => {
                sessionExpiredLogout();
            }, SESSION_TIMEOUT_MS);
            
            // Show and start countdown timer
            showSessionTimer();
            updateCountdown(expiryTime);
            
            countdownTimer = setInterval(() => {
                updateCountdown(expiryTime);
            }, 1000);
        }
        
        // Stop session timer
        function stopSessionTimer() {
            if (logoutTimer) clearTimeout(logoutTimer);
            if (countdownTimer) clearInterval(countdownTimer);
            hideSessionTimer();
        }
        
        // Show session timer in footer
        function showSessionTimer() {
            const timer = document.getElementById('sessionTimer');
            if (timer) {
                timer.style.display = 'block';
            }
        }
        
        // Hide session timer
        function hideSessionTimer() {
            const timer = document.getElementById('sessionTimer');
            if (timer) {
                timer.style.display = 'none';
                timer.className = 'session-timer'; // Reset classes
            }
        }
        
        // Update countdown display
        function updateCountdown(expiryTime) {
            const now = Date.now();
            const timeLeft = expiryTime - now;
            
            if (timeLeft <= 0) {
                // Time's up
                const countdown = document.getElementById('sessionCountdown');
                if (countdown) countdown.textContent = '0:00';
                return;
            }
            
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const countdown = document.getElementById('sessionCountdown');
            const timer = document.getElementById('sessionTimer');
            
            if (countdown) countdown.textContent = timeString;
            
            // Change styling based on time remaining
            if (timer) {
                timer.className = 'session-timer'; // Reset
                if (timeLeft < 60000) { // Less than 1 minute
                    timer.classList.add('danger');
                } else if (timeLeft < 300000) { // Less than 5 minutes
                    timer.classList.add('warning');
                }
            }
        }
        
        // Handle session expiration
        function sessionExpiredLogout() {
            alert('Your session has expired for security reasons. Please log in again.');
            logout();
        }


        // Login functionality
        async function login(username, password) {
            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    // Store token in localStorage for cross-page access
                    localStorage.setItem('authToken', data.access_token);
                    currentUser = { username };
                    showMainApp();
                    if (window.refreshHeaderUser) { window.refreshHeaderUser(); }
                    loadUserInfo();
                    refreshMoves();
                    // Start session timer
                    startSessionTimer();
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

                       // Show main application
                       function showMainApp() {
            document.getElementById('login-section').classList.add('d-none');
            document.getElementById('main-app').classList.remove('d-none');
            document.getElementById('login-btn').classList.add('d-none');
            document.getElementById('user-dropdown').classList.remove('d-none');
            // Move history button is now in left sidebar
            
            // Load initial data
            refreshMoves();
        }

        // Show login form
        function showLogin() {
            // Clear any existing state
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            
            // Reset move suggestions buttons back to initial state
            showLoadButton();
            
            // Show login, hide main app
            document.getElementById('login-section').classList.remove('d-none');
            document.getElementById('main-app').classList.add('d-none');
            document.getElementById('login-btn').classList.remove('d-none');
            document.getElementById('user-dropdown').classList.add('d-none');
            // Move history button is now in left sidebar
        }

        // Logout
        function logout() {
            // Stop session timer
            stopSessionTimer();
            
            authToken = null;
            currentUser = null;
            
            // Clear token from localStorage
            localStorage.removeItem('authToken');
            
            // Clear all cached data
            window.availableProperties = null;
            
            // Clear property filter dropdown
            const propertyFilter = document.getElementById('property-filter');
            if (propertyFilter) {
                propertyFilter.innerHTML = '<option value="">Select Property</option>';
            }
            
            // Clear move suggestions display
            const movesContainer = document.getElementById('moves-container');
            if (movesContainer) {
                movesContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <p>Select a property and click "Load Move Suggestions" to begin</p>
                    </div>`;
            }
            
            // Reset cache status badge
            const cacheStatus = document.getElementById('cache-status');
            if (cacheStatus) {
                cacheStatus.textContent = 'No data loaded';
                cacheStatus.className = 'badge bg-secondary ms-2';
            }
            
            // Reset move suggestions buttons back to initial state
            showLoadButton();
            
            // Hide admin elements immediately
            const userMgmtLink = document.getElementById('user-management-link');
            const adminSetupCard = document.getElementById('admin-setup-card');
            if (userMgmtLink) {
                userMgmtLink.style.display = 'none';
            }
            if (adminSetupCard) {
                adminSetupCard.classList.add('d-none');
            }
            
            // Switch UI back to login screen
            document.getElementById('login-section').classList.remove('d-none');
            document.getElementById('main-app').classList.add('d-none');
            document.getElementById('login-btn').classList.remove('d-none');
            document.getElementById('user-dropdown').classList.add('d-none');
            document.getElementById('username').textContent = 'Guest';
            
            // Reset login form
            if (document.getElementById('username-input')) {
                document.getElementById('username-input').value = '';
            }
            if (document.getElementById('password-input')) {
                document.getElementById('password-input').value = '';
            }
            
            console.log('User logged out and all data cleared');
        }

                       // Load user information
               async function loadUserInfo() {
                   if (!authToken) return;
                   
                   try {
                       const response = await fetch('/api/v1/auth/me', {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           const user = await response.json();
                           currentUser = user;
                           document.getElementById('username').textContent = user.username;
                           
                           // Show/hide admin elements based on user role
                           const userMgmtLink = document.getElementById('user-management-link');
                           const adminSetupCard = document.getElementById('admin-setup-card');
                           
                           if (user.is_admin) {
                               // Show admin elements for admin users
                               if (userMgmtLink) {
                                   userMgmtLink.style.display = 'block';
                               }
                               if (adminSetupCard) {
                                   adminSetupCard.classList.remove('d-none');
                               }
                           } else {
                               // Hide admin elements for non-admin users
                               if (userMgmtLink) {
                                   userMgmtLink.style.display = 'none';
                               }
                               if (adminSetupCard) {
                                   adminSetupCard.classList.add('d-none');
                               }
                           }
                           
                           // Show Move History nav link for all authenticated users
                           // Move history button is now in left sidebar
                           
                           // Load user properties to populate filters
                           loadUserProperties();
                       }
                   } catch (error) {
                       console.error('Error loading user info:', error);
                   }
               }

               // Load user properties for property filter
               async function loadUserProperties() {
                   if (!authToken) {
                       return;
                   }
                   
                   try {
                       // Admin users see all properties, regular users see only their assigned properties
                       let url = '/api/v1/user-properties/my-properties';
                       if (currentUser && currentUser.is_admin) {
                           url = '/api/v1/properties/';
                       }
                       
                       const response = await fetch(url, {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           let data;
                           if (currentUser && currentUser.is_admin) {
                               // For admin users, convert properties to user-property format
                               const properties = await response.json();
                               data = properties.map(prop => ({
                                   property_id: prop.id,
                                   property: prop,
                                   is_primary: false
                               }));
                           } else {
                               // For regular users, use the user-properties response
                               data = await response.json();
                           }
                           populatePropertyFilter(data);
                       } else {
                           const errorText = await response.text();
                           console.error('Failed to load user properties:', response.status, errorText);
                       }
                   } catch (error) {
                       console.error('Error loading user properties:', error);
                   }
               }

               // Populate property filter dropdown
               function populatePropertyFilter(userProperties) {
                   const propertyFilter = document.getElementById('property-filter');
                   if (!propertyFilter) {
                       console.error('Property filter element not found');
                       return;
                   }
                   
                   // Clear existing options except placeholder
                   propertyFilter.innerHTML = '<option value="">Select Property</option>';
                   
                   if (userProperties && userProperties.length > 0) {
                       userProperties.forEach((up, index) => {
                           
                           const option = document.createElement('option');
                           
                           // Handle different data structures and store property code in value
                           let propertyCode = '';
                           let displayText = '';
                           
                           if (up.property) {
                               // User-property format
                               propertyCode = up.property.property_code || `PROP${up.property_id}`;
                               displayText = up.property.property_name || up.property.property_code || `Property ${up.property_id}`;
                           } else if (up.property_code) {
                               // Direct property format
                               propertyCode = up.property_code;
                               displayText = up.property_name || up.property_code;
                           } else {
                               // Fallback
                               propertyCode = `PROP${up.property_id}`;
                               displayText = `Property ${up.property_id}`;
                           }
                           
                           option.value = propertyCode;
                           
                           if (up.is_primary) {
                               displayText += ' (Primary)';
                           }
                           
                           option.textContent = displayText;
                           propertyFilter.appendChild(option);
                           
                       });
                   }
               }





        // Show alert message
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the main container (supports container and container-fluid)
            const container = document.querySelector('.container') || document.querySelector('.container-fluid');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            } else {
                document.body.prepend(alertDiv);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Refresh moves
        async function refreshMoves() {
            if (!authToken) return;
            
            try {
                const propertyFilter = document.getElementById('property-filter').value;
                
                // Only try to load moves if we have both auth token and property filter
                if (!propertyFilter) {
                    console.log('No property selected, skipping move refresh');
                    return;
                }
                
                let url = '/api/v1/defrag-moves/suggestions/' + propertyFilter;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Set current property code for chart functionality
                    setCurrentPropertyCode(propertyFilter);
                    
                    displayMoveSuggestions({...data, propertyCode: propertyFilter});
                } else {
                    console.log('No existing move suggestions found, use Load Move Suggestions to generate new ones');
                    // Clear the display
                    const container = document.getElementById('moves-container');
                    if (container) {
                        container.innerHTML = `
                            <p class="text-muted text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                Select a property and click "Load Move Suggestions" to begin
                            </p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading moves:', error);
                // Don't show error to user for this background refresh
            }
        }

        // Display moves
        function displayMoves(moves) {
            const container = document.getElementById('moves-container');
            const countElement = document.getElementById('move-count');
            
            countElement.textContent = moves.length;
            
            if (moves.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>No moves found</p>
                    </div>
                `;
                return;
            }
            
            const movesHtml = moves.map(move => `
                <div class="card move-card mb-3 status-${move.status}" onclick="showMoveDetails(${move.id})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="card-title mb-1">Move #${move.id}</h6>
                                <p class="card-text text-muted mb-1">
                                    <i class="fas fa-building me-1"></i>Property ID: ${move.property_id}
                                </p>
                                <p class="card-text text-muted mb-0">
                                    <i class="fas fa-clock me-1"></i>${new Date(move.created_at).toLocaleString()}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-${getStatusColor(move.status)}">${move.status}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = movesHtml;
        }

        // Get status color
        function getStatusColor(status) {
            switch (status) {
                case 'pending': return 'warning';
                case 'approved': return 'success';
                case 'rejected': return 'danger';
                case 'applied': return 'info';
                default: return 'secondary';
            }
        }

        // Show move details
        async function showMoveDetails(moveId, moveDataId = null) {
            if (!authToken) return;
            
            try {
                let move;
                
                if (moveDataId) {
                    // This is a move suggestion from the table
                    const response = await fetch(`/api/v1/defrag-moves/${moveDataId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const moveData = await response.json();
                        // Create a move object from the suggestion data
                        move = {
                            id: moveData.id,
                            property_id: moveData.property_id,
                            property_code: moveData.property_code,
                            status: moveData.status,
                            created_at: moveData.created_at,
                            suggested_by: moveData.suggested_by,
                            approved_by: moveData.approved_by,
                            approved_at: moveData.approved_at,
                            move_data: moveData.move_data,
                            is_suggestion: true,
                            suggestion_index: moveId // This is the index in the suggestions array
                        };
                    }
                } else {
                    // This is a regular move from the old system
                    const response = await fetch(`/api/v1/defrag-moves/${moveId}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        move = await response.json();
                        move.is_suggestion = false;
                    }
                }
                
                if (move) {
                    showMoveModal(move);
                }
            } catch (error) {
                console.error('Error loading move details:', error);
            }
        }

        // Show move modal
        function showMoveModal(move) {
            const modal = new bootstrap.Modal(document.getElementById('moveModal'));
            const content = document.getElementById('move-modal-content');
            const actions = document.getElementById('move-modal-actions');
            
            let contentHtml = '';
            
            if (move.is_suggestion) {
                // Display move suggestion details
                const suggestions = move.move_data.moves || [];
                const suggestion = suggestions[move.suggestion_index] || {};
                
                contentHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Property:</strong> ${move.property_code}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(move.status)}">${move.status}</span></p>
                            <p><strong>Analysis Date:</strong> ${new Date(move.move_data.analysis_date).toLocaleString()}</p>
                            <p><strong>Total Suggestions:</strong> ${move.move_data.move_count}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Suggested by:</strong> ${move.suggested_by || 'System'}</p>
                            <p><strong>Created:</strong> ${new Date(move.created_at).toLocaleString()}</p>
                            <p><strong>Cache Age:</strong> ${move.move_data.cache_age_hours || 0} hours</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h6>Move Suggestion Details:</h6>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>From Unit:</strong> ${suggestion.from_unit}</p>
                                        <p><strong>To Unit:</strong> ${suggestion.to_unit}</p>
                                        <p><strong>Guest:</strong> ${suggestion.guest_name}</p>
                                        <p><strong>Category:</strong> ${suggestion.category}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>From Date:</strong> ${suggestion.from_date}</p>
                                        <p><strong>To Date:</strong> ${suggestion.to_date}</p>
                                        <p><strong>Strategic Importance:</strong> 
                                            <span class="badge bg-${getStrategicImportanceColor(suggestion.strategic_importance)}">
                                                ${suggestion.strategic_importance}
                                            </span>
                                        </p>
                                        <p><strong>Score:</strong> 
                                            <span class="badge bg-${getScoreColor(suggestion.score)}">
                                                ${suggestion.score}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <p><strong>Constraint Period:</strong> ${suggestion.constraint_period}</p>
                                    <p><strong>Reason:</strong> ${suggestion.reason || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Display regular move details (old format)
                contentHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Move ID:</strong> ${move.id}</p>
                            <p><strong>Property ID:</strong> ${move.property_id}</p>
                            <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(move.status)}">${move.status}</span></p>
                            <p><strong>Created:</strong> ${new Date(move.created_at).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Suggested by:</strong> ${move.suggested_by || 'N/A'}</p>
                            <p><strong>Approved by:</strong> ${move.approved_by || 'N/A'}</p>
                            <p><strong>Approved at:</strong> ${move.approved_at ? new Date(move.approved_at).toLocaleString() : 'N/A'}</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Move Data:</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(move.move_data, null, 2)}</pre>
                    </div>
                `;
            }
            
            content.innerHTML = contentHtml;
            
            // Show actions based on status
            if (move.status === 'pending') {
                actions.innerHTML = `
                    <button type="button" class="btn btn-success" onclick="approveMove(${move.id}, 'approve')">
                        <i class="fas fa-check me-1"></i>Approve
                    </button>
                    <button type="button" class="btn btn-danger" onclick="approveMove(${move.id}, 'reject')">
                        <i class="fas fa-times me-1"></i>Reject
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            } else {
                actions.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            modal.show();
        }

        // Approve/reject move
        async function approveMove(moveId, action) {
            if (!authToken) return;
            
            try {
                const response = await fetch(`/api/v1/defrag-moves/${moveId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        move_id: moveId,
                        action: action
                    })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('moveModal')).hide();
                    refreshMoves();
                    alert(`Move ${action}d successfully!`);
                } else {
                    alert('Failed to update move status.');
                }
            } catch (error) {
                console.error('Error updating move:', error);
                alert('Failed to update move status.');
            }
        }

                       // Profile management functions
               function showProfileEdit() {
                   if (!currentUser) return;
                   
                   // Populate form with current user data
                   document.getElementById('profile-email').value = currentUser.email || '';
                   document.getElementById('profile-first-name').value = currentUser.first_name || '';
                   document.getElementById('profile-last-name').value = currentUser.last_name || '';
                   
                   const modal = new bootstrap.Modal(document.getElementById('profileModal'));
                   modal.show();
               }

               async function updateProfile() {
                   if (!authToken) return;
                   
                   const email = document.getElementById('profile-email').value;
                   const firstName = document.getElementById('profile-first-name').value;
                   const lastName = document.getElementById('profile-last-name').value;
                   
                   try {
                       const response = await fetch('/api/v1/auth/me', {
                           method: 'PUT',
                           headers: {
                               'Authorization': `Bearer ${authToken}`,
                               'Content-Type': 'application/json'
                           },
                           body: JSON.stringify({
                               email: email,
                               first_name: firstName,
                               last_name: lastName
                           })
                       });
                       
                       if (response.ok) {
                           const updatedUser = await response.json();
                           currentUser = updatedUser;
                           bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                           alert('Profile updated successfully!');
                           loadUserInfo();
                       } else {
                           const error = await response.json();
                           alert(`Failed to update profile: ${error.detail}`);
                       }
                   } catch (error) {
                       console.error('Error updating profile:', error);
                       alert('Failed to update profile.');
                   }
               }

               function showPasswordChange() {
                   // Clear form
                   document.getElementById('current-password').value = '';
                   document.getElementById('new-password').value = '';
                   document.getElementById('confirm-password').value = '';
                   
                   const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
                   modal.show();
               }

               async function changePassword() {
                   if (!authToken) return;
                   
                   const currentPassword = document.getElementById('current-password').value;
                   const newPassword = document.getElementById('new-password').value;
                   const confirmPassword = document.getElementById('confirm-password').value;
                   
                   if (newPassword !== confirmPassword) {
                       alert('New passwords do not match!');
                       return;
                   }
                   
                   try {
                       const response = await fetch('/api/v1/auth/me/change-password', {
                           method: 'PUT',
                           headers: {
                               'Authorization': `Bearer ${authToken}`,
                               'Content-Type': 'application/json'
                           },
                           body: JSON.stringify({
                               current_password: currentPassword,
                               new_password: newPassword
                           })
                       });
                       
                       if (response.ok) {
                           bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
                           alert('Password changed successfully!');
                       } else {
                           const error = await response.json();
                           alert(`Failed to change password: ${error.detail}`);
                       }
                   } catch (error) {
                       console.error('Error changing password:', error);
                       alert('Failed to change password.');
                   }
               }

               // User management functions
               function showUserManagement() {
                   const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
                   modal.show();
                   loadUsers();
               }

               async function loadUsers() {
                   if (!authToken) return;
                   
                   try {
                       const response = await fetch('/api/v1/auth/users', {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           const users = await response.json();
                           displayUsers(users);
                       }
                   } catch (error) {
                       console.error('Error loading users:', error);
                   }
               }

               function displayUsers(users) {
                   const container = document.getElementById('users-list');
                   
                   if (users.length === 0) {
                       container.innerHTML = '<p class="text-muted">No users found</p>';
                       return;
                   }
                   
                   const usersHtml = users.map(user => `
                       <div class="card mb-2">
                           <div class="card-body">
                               <div class="row align-items-center">
                                   <div class="col-md-3">
                                       <strong>${user.username}</strong>
                                       ${user.is_admin ? '<span class="badge bg-danger ms-2">Admin</span>' : ''}
                                   </div>
                                   <div class="col-md-3">${user.email}</div>
                                   <div class="col-md-2">${user.first_name || 'N/A'} ${user.last_name || ''}</div>
                                   <div class="col-md-2">
                                       <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                                           ${user.is_active ? 'Active' : 'Inactive'}
                                       </span>
                                   </div>
                                   <div class="col-md-2">
                                       <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">
                                           <i class="fas fa-edit"></i>
                                       </button>
                                       ${!user.is_admin ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                                           <i class="fas fa-trash"></i>
                                       </button>` : ''}
                                   </div>
                               </div>
                           </div>
                       </div>
                   `).join('');
                   
                   container.innerHTML = usersHtml;
               }

               function showCreateUser() {
                   // Reset form to create mode
                   resetCreateUserForm();
                   
                   // Load properties for assignment
                   loadPropertiesForUserCreation();
                   
                   const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
                   modal.show();
               }

               // Load properties for user creation
               async function loadPropertiesForUserCreation() {
                   if (!authToken) return;
                   
                   console.log('Loading properties for user creation...');
                   
                   try {
                       const response = await fetch('/api/v1/properties/', {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       console.log('Properties response status:', response.status);
                       
                       if (response.ok) {
                           const properties = await response.json();
                           console.log('Properties loaded:', properties.length, 'properties');
                           window.availableProperties = properties; // Store globally for dropdowns
                           displayPropertiesForUserCreation(properties);
                       } else {
                           console.error('Failed to load properties:', response.status);
                           const errorText = await response.text();
                           console.error('Error response:', errorText);
                       }
                   } catch (error) {
                       console.error('Error loading properties for user creation:', error);
                   }
               }

               // Display properties for user creation
               function displayPropertiesForUserCreation(properties) {
                   const container = document.getElementById('create-user-properties-list');
                   
                   console.log('Displaying properties for user creation. Container:', container);
                   console.log('Properties to display:', properties);
                   
                   if (!properties || properties.length === 0) {
                       console.log('No properties available, showing message');
                       container.innerHTML = '<div class="text-muted small">No properties available</div>';
                       return;
                   }
                   
                   console.log('Properties available, updating container');
                   
                   // Clear the loading message and prepare container for property assignments
                   container.innerHTML = '<div class="text-muted small">No properties assigned yet</div>';
                   
                   // Store properties globally for dropdowns
                   window.availableProperties = properties;
                   console.log('Properties stored globally:', window.availableProperties);
               }

               // Add property to user creation
               function addPropertyToCreateUser() {
                   const container = document.getElementById('create-user-properties-list');
                   
                   // Check if properties are loaded
                   if (!window.availableProperties || window.availableProperties.length === 0) {
                       alert('Properties are still loading. Please wait a moment and try again.');
                       return;
                   }
                   
                   // Create property selection row
                   const propertyRow = document.createElement('div');
                   propertyRow.className = 'd-flex align-items-center mb-2';
                   propertyRow.innerHTML = `
                       <select class="form-select form-select-sm me-2" style="flex: 1;" onchange="handlePropertySelection(this)">
                           <option value="">Select Property</option>
                           ${getPropertiesOptions()}
                       </select>
                       <div class="form-check me-2">
                           <input class="form-check-input" type="checkbox" onchange="handlePrimaryChange(this)">
                           <label class="form-check-label small">Primary</label>
                       </div>
                       <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePropertyFromCreateUser(this)">
                           <i class="fas fa-times"></i>
                       </button>
                   `;
                   
                   container.appendChild(propertyRow);
                   
                   // Update container message
                   if (container.querySelector('.text-muted')) {
                       container.querySelector('.text-muted').remove();
                   }
               }

               // Remove property from user creation
               function removePropertyFromCreateUser(button) {
                   const row = button.closest('.d-flex');
                   const container = document.getElementById('create-user-properties-list');
                   const primaryCheckbox = row.querySelector('input[type="checkbox"]');
                   
                   // Check if this is a primary property
                   if (primaryCheckbox && primaryCheckbox.checked) {
                       // Count other properties
                       const otherProperties = container.querySelectorAll('.d-flex');
                       if (otherProperties.length <= 1) {
                           alert('Cannot delete the only primary property. You must have at least one primary property assigned.');
                           return;
                       }
                       
                       // Find another property to make primary
                       let foundReplacement = false;
                       otherProperties.forEach(propRow => {
                           if (propRow !== row) {
                               const select = propRow.querySelector('select');
                               if (select && select.value) {
                                   const checkbox = propRow.querySelector('input[type="checkbox"]');
                                   if (checkbox) {
                                       checkbox.checked = true;
                                       foundReplacement = true;
                                   }
                               }
                           }
                       });
                       
                       if (!foundReplacement) {
                           alert('Cannot delete primary property without another property to replace it.');
                           return;
                       }
                   }
                   
                   // If this was the last property row, show message
                   if (container.children.length === 1) {
                       container.innerHTML = '<div class="text-muted small">No properties assigned yet</div>';
                   } else {
                       row.remove();
                   }
               }

               // Handle property selection change
               function handlePropertySelection(select) {
                   const row = select.closest('.d-flex');
                   const primaryCheckbox = row.querySelector('input[type="checkbox"]');
                   
                   // If this is the first property selected, make it primary
                   if (select.value && !hasAnyPrimaryProperty()) {
                       primaryCheckbox.checked = true;
                   }
               }

               // Handle primary property change
               function handlePrimaryChange(checkbox) {
                   if (checkbox.checked) {
                       // Uncheck all other primary checkboxes
                       const container = document.getElementById('create-user-properties-list');
                       const allCheckboxes = container.querySelectorAll('input[type="checkbox"]');
                       
                       allCheckboxes.forEach(cb => {
                           if (cb !== checkbox) {
                               cb.checked = false;
                           }
                       });
                   }
               }

               // Check if any property is marked as primary
               function hasAnyPrimaryProperty() {
                   const container = document.getElementById('create-user-properties-list');
                   const primaryCheckbox = container.querySelector('input[type="checkbox"]:checked');
                   return primaryCheckbox !== null;
               }

               // Update user property assignments
               async function updateUserPropertyAssignments(userId, newAssignments) {
                   try {
                       // First, get current assignments
                       const currentResponse = await fetch(`/api/v1/user-properties/user/${userId}/properties`, {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (currentResponse.ok) {
                           const currentAssignments = await currentResponse.json();
                           
                           // Remove assignments that are no longer present
                           for (const current of currentAssignments) {
                               const stillExists = newAssignments.some(newAssign => 
                                   newAssign.property_id === current.property_id
                               );
                               
                               if (!stillExists) {
                                   await fetch(`/api/v1/user-properties/${current.id}`, {
                                       method: 'DELETE',
                                       headers: {
                                           'Authorization': `Bearer ${authToken}`
                                       }
                                   });
                               }
                           }
                           
                           // Update or create new assignments
                           for (const newAssign of newAssignments) {
                               const existing = currentAssignments.find(current => 
                                   current.property_id === newAssign.property_id
                               );
                               
                               if (existing) {
                                   // Update existing assignment
                                   await fetch(`/api/v1/user-properties/${existing.id}`, {
                                       method: 'PUT',
                                       headers: {
                                           'Authorization': `Bearer ${authToken}`,
                                           'Content-Type': 'application/json'
                                       },
                                       body: JSON.stringify({
                                           is_primary: newAssign.is_primary
                                       })
                                   });
                               } else {
                                   // Create new assignment
                                   await fetch('/api/v1/user-properties/assign', {
                                       method: 'POST',
                                       headers: {
                                           'Authorization': `Bearer ${authToken}`,
                                           'Content-Type': 'application/json'
                                       },
                                       body: JSON.stringify({
                                           user_id: userId,
                                           property_id: newAssign.property_id,
                                           is_primary: newAssign.is_primary
                                       })
                                   });
                               }
                           }
                       }
                   } catch (error) {
                       console.error('Error updating user property assignments:', error);
                       throw error;
                   }
               }

               // Get properties options for dropdown
               function getPropertiesOptions() {
                   console.log('Getting properties options. Available properties:', window.availableProperties);
                   
                   if (!window.availableProperties) {
                       console.log('No available properties found');
                       return '';
                   }
                   
                   const options = window.availableProperties.map(prop => 
                       `<option value="${prop.id}">${prop.property_name} (${prop.property_code})</option>`
                   ).join('');
                   
                   console.log('Generated options:', options);
                   return options;
               }

               // Load existing user property assignments for editing
               async function loadUserPropertyAssignments(userId) {
                   if (!authToken) return;
                   
                   try {
                       // First ensure properties are loaded
                       if (!window.availableProperties || window.availableProperties.length === 0) {
                           console.log('Properties not loaded yet, loading them first...');
                           await loadPropertiesForUserCreation();
                       }
                       
                       const response = await fetch(`/api/v1/user-properties/user/${userId}/properties`, {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           const userProperties = await response.json();
                           console.log('User property assignments loaded:', userProperties);
                           displayExistingUserPropertyAssignments(userProperties);
                       } else {
                           console.error('Failed to load user property assignments');
                           // Show empty state
                           displayExistingUserPropertyAssignments([]);
                       }
                   } catch (error) {
                       console.error('Error loading user property assignments:', error);
                       // Show empty state
                       displayExistingUserPropertyAssignments([]);
                   }
               }

               // Display existing user property assignments
               function displayExistingUserPropertyAssignments(userProperties) {
                   const container = document.getElementById('create-user-properties-list');
                   
                   console.log('displayExistingUserPropertyAssignments called with:', userProperties);
                   console.log('Available properties:', window.availableProperties);
                   
                   if (!userProperties || userProperties.length === 0) {
                       container.innerHTML = '<div class="text-muted small">No properties assigned yet</div>';
                       return;
                   }
                   
                   // Clear container
                   container.innerHTML = '';
                   
                   // Add each existing assignment
                   userProperties.forEach(up => {
                       console.log('Creating property row for assignment:', up);
                       const propertyRow = document.createElement('div');
                       propertyRow.className = 'd-flex align-items-center mb-2';
                       
                       // Get property options before creating the row
                       const propertyOptions = getPropertiesOptions();
                       console.log('Property options generated:', propertyOptions);
                       
                       propertyRow.innerHTML = `
                           <select class="form-select form-select-sm me-2" style="flex: 1;" onchange="handlePropertySelection(this)">
                               <option value="">Select Property</option>
                               ${propertyOptions}
                           </select>
                           <div class="form-check me-2">
                               <input class="form-check-input" type="checkbox" onchange="handlePrimaryChange(this)" ${up.is_primary ? 'checked' : ''}>
                               <label class="form-check-label small">Primary</label>
                           </div>
                           <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePropertyFromCreateUser(this)">
                               <i class="fas fa-times"></i>
                           </button>
                       `;
                       
                       // Set the selected property
                       const select = propertyRow.querySelector('select');
                       if (select) {
                           console.log('Setting select value to:', up.property_id);
                           select.value = up.property_id;
                       }
                       
                       container.appendChild(propertyRow);
                   });
                   
                   console.log('Finished creating property rows');
               }

               async function createUser() {
                   if (!authToken) return;
                   
                   const username = document.getElementById('create-username').value;
                   const email = document.getElementById('create-email').value;
                   const password = document.getElementById('create-password').value;
                   const firstName = document.getElementById('create-first-name').value;
                   const lastName = document.getElementById('create-last-name').value;
                   const isAdmin = document.getElementById('create-is-admin').checked;
                   
                   // Get property assignments
                   const propertyAssignments = [];
                   const propertyRows = document.querySelectorAll('#create-user-properties-list .d-flex');
                   
                   propertyRows.forEach(row => {
                       const propertySelect = row.querySelector('select');
                       const primaryCheckbox = row.querySelector('input[type="checkbox"]');
                       
                       if (propertySelect && propertySelect.value) {
                           propertyAssignments.push({
                               property_id: parseInt(propertySelect.value),
                               is_primary: primaryCheckbox ? primaryCheckbox.checked : false
                           });
                       }
                   });
                   
                   // Validate that at least one property is assigned and marked as primary
                   if (propertyAssignments.length === 0) {
                       alert('You must assign at least one property to the user.');
                       return;
                   }
                   
                   const primaryProperties = propertyAssignments.filter(pa => pa.is_primary);
                   if (primaryProperties.length === 0) {
                       alert('You must mark at least one property as primary.');
                       return;
                   }
                   
                   if (primaryProperties.length > 1) {
                       alert('Only one property can be marked as primary.');
                       return;
                   }
                   
                   try {
                       // First create the user
                       const response = await fetch('/api/v1/auth/users', {
                           method: 'POST',
                           headers: {
                               'Authorization': `Bearer ${authToken}`,
                               'Content-Type': 'application/json'
                           },
                           body: JSON.stringify({
                               username: username,
                               email: email,
                               password: password,
                               first_name: firstName,
                               last_name: lastName,
                               is_admin: isAdmin
                           })
                       });
                       
                       if (response.ok) {
                           const newUser = await response.json();
                           
                           // Then assign properties if any were selected
                           if (propertyAssignments.length > 0) {
                               for (const assignment of propertyAssignments) {
                                   try {
                                       const assignResponse = await fetch('/api/v1/user-properties/assign', {
                                           method: 'POST',
                                           headers: {
                                               'Authorization': `Bearer ${authToken}`,
                                               'Content-Type': 'application/json'
                                           },
                                           body: JSON.stringify({
                                               user_id: newUser.id,
                                               property_id: assignment.property_id,
                                               is_primary: assignment.is_primary
                                           })
                                       });
                                       
                                       if (!assignResponse.ok) {
                                           console.warn(`Failed to assign property ${assignment.property_id} to user ${newUser.id}`);
                                       }
                                   } catch (error) {
                                       console.error('Error assigning property:', error);
                                   }
                               }
                           }
                           
                           bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                           alert('User created successfully!');
                           loadUsers();
                       } else {
                           const error = await response.json();
                           alert(`Failed to create user: ${error.detail}`);
                       }
                   } catch (error) {
                       console.error('Error creating user:', error);
                       alert('Failed to create user.');
                   }
               }

               async function deleteUser(userId) {
                   if (!authToken || !confirm('Are you sure you want to delete this user?')) return;
                   
                   try {
                       const response = await fetch(`/api/v1/auth/users/${userId}`, {
                           method: 'DELETE',
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           alert('User deleted successfully!');
                           loadUsers();
                       } else {
                           const error = await response.json();
                           alert(`Failed to delete user: ${error.detail}`);
                       }
                   } catch (error) {
                       console.error('Error deleting user:', error);
                       alert('Failed to delete user.');
                   }
               }

               async function editUser(userId) {
                   if (!authToken) return;
                   
                   try {
                       // Get user details
                       const response = await fetch(`/api/v1/auth/users/${userId}`, {
                           headers: {
                               'Authorization': `Bearer ${authToken}`
                           }
                       });
                       
                       if (response.ok) {
                           const user = await response.json();
                           showEditUserModal(user);
                       } else {
                           alert('Failed to load user details.');
                       }
                   } catch (error) {
                       console.error('Error loading user details:', error);
                       alert('Failed to load user details.');
                   }
               }

               function showEditUserModal(user) {
                   // Populate the create user form with existing user data
                   document.getElementById('create-username').value = user.username;
                   document.getElementById('create-email').value = user.email;
                   document.getElementById('create-first-name').value = user.first_name || '';
                   document.getElementById('create-last-name').value = user.last_name || '';
                   document.getElementById('create-is-admin').checked = user.is_admin;
                   
                   // Change the modal title and button
                   document.querySelector('#createUserModal .modal-title').textContent = 'Edit User';
                   document.querySelector('#createUserModal .modal-footer .btn-primary').textContent = 'Update User';
                   document.querySelector('#createUserModal .modal-footer .btn-primary').onclick = () => updateUser(user.id);
                   
                   // Disable username field (cannot change username)
                   document.getElementById('create-username').disabled = true;
                   
                   // Load properties for editing
                   loadPropertiesForUserCreation();
                   
                   // Load existing user property assignments
                   loadUserPropertyAssignments(user.id);
                   
                   // Show the modal
                   const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
                   modal.show();
               }

               async function updateUser(userId) {
                   if (!authToken) return;
                   
                   const email = document.getElementById('create-email').value;
                   const firstName = document.getElementById('create-first-name').value;
                   const lastName = document.getElementById('create-last-name').value;
                   const isAdmin = document.getElementById('create-is-admin').checked;
                   
                   // Get property assignments
                   const propertyAssignments = [];
                   const propertyRows = document.querySelectorAll('#create-user-properties-list .d-flex');
                   
                   propertyRows.forEach(row => {
                       const propertySelect = row.querySelector('select');
                       const primaryCheckbox = row.querySelector('input[type="checkbox"]');
                       
                       if (propertySelect && propertySelect.value) {
                           propertyAssignments.push({
                               property_id: parseInt(propertySelect.value),
                               is_primary: primaryCheckbox ? primaryCheckbox.checked : false
                           });
                       }
                   });
                   
                   // Validate that at least one property is assigned and marked as primary
                   if (propertyAssignments.length === 0) {
                       alert('You must assign at least one property to the user.');
                       return;
                   }
                   
                   const primaryProperties = propertyAssignments.filter(pa => pa.is_primary);
                   if (primaryProperties.length === 0) {
                       alert('You must mark at least one property as primary.');
                       return;
                   }
                   
                   if (primaryProperties.length > 1) {
                       alert('Only one property can be marked as primary.');
                       return;
                   }
                   
                   try {
                       // First update the user details
                       const response = await fetch(`/api/v1/auth/users/${userId}`, {
                           method: 'PUT',
                           headers: {
                               'Authorization': `Bearer ${authToken}`,
                               'Content-Type': 'application/json'
                           },
                           body: JSON.stringify({
                               email: email,
                               first_name: firstName,
                               last_name: lastName,
                               is_admin: isAdmin
                           })
                       });
                       
                       if (response.ok) {
                           // Then update property assignments
                           await updateUserPropertyAssignments(userId, propertyAssignments);
                           
                           bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                           alert('User updated successfully!');
                           loadUsers();
                           
                           // Reset form and button
                           resetCreateUserForm();
                       } else {
                           const error = await response.json();
                           alert(`Failed to update user: ${error.detail}`);
                       }
                   } catch (error) {
                       console.error('Error updating user:', error);
                       alert('Failed to update user.');
                   }
               }

               function resetCreateUserForm() {
                   // Reset form fields
                   document.getElementById('create-username').value = '';
                   document.getElementById('create-email').value = '';
                   document.getElementById('create-password').value = '';
                   document.getElementById('create-first-name').value = '';
                   document.getElementById('create-last-name').value = '';
                   document.getElementById('create-is-admin').checked = false;
                   
                   // Re-enable username field
                   document.getElementById('create-username').disabled = false;
                   
                   // Reset property assignments
                   const container = document.getElementById('create-user-properties-list');
                   if (container) {
                       container.innerHTML = '<div class="text-muted small">No properties assigned yet</div>';
                   }
                   
                   // Reset modal title and button
                   document.querySelector('#createUserModal .modal-title').textContent = 'Create New User';
                   document.querySelector('#createUserModal .modal-footer .btn-primary').textContent = 'Create User';
                   document.querySelector('#createUserModal .modal-footer .btn-primary').onclick = createUser;
               }

               // Event listeners
               document.getElementById('login-form').addEventListener('submit', function(e) {
                   e.preventDefault();
                   const username = document.getElementById('username-input').value;
                   const password = document.getElementById('password-input').value;
                   login(username, password);
               });

               // Status filter removed; refresh bound to property changes and explicit actions only
               // Note: property-filter change should NOT auto-refresh moves - user must click "Load Move Suggestions"

        // RMS API WebSocket Management
    let rmsWebSocket = null;
    let rmsAutoScroll = true;
    let currentPropertyCode = null;
    
    // Promisified WebSocket connection function
    function connectRmsWebSocketAndWait(propertyCode) {
        return new Promise((resolve, reject) => {
            if (rmsWebSocket && rmsWebSocket.readyState === WebSocket.OPEN) {
                disconnectRmsWebSocket();
            }
            
            currentPropertyCode = propertyCode;
            const wsUrl = `ws://${window.location.host}/ws/rms-progress/${propertyCode}`;
            
            addRmsDebugLine('info', `Connecting to real-time updates for ${propertyCode}...`);
            
            try {
                rmsWebSocket = new WebSocket(wsUrl);
                
                rmsWebSocket.onopen = function(event) {
                    console.log('RMS WebSocket connected');
                    updateRmsStatus('Connected', 'bg-success');
                    addRmsDebugLine('success', 'WebSocket connected successfully');
                    addRmsDebugLine('info', `Connected to real-time updates for ${propertyCode}`);
                    
                    // Connection controls have been removed - auto-managed now
                    
                    // Start ping interval
                    startRmsPingInterval();
                    
                    // Resolve the promise when connected
                    resolve();
                };
                
                rmsWebSocket.onerror = function(error) {
                    console.error('RMS WebSocket error:', error);
                    updateRmsStatus('Error', 'bg-danger');
                    addRmsDebugLine('error', 'WebSocket connection error');
                    reject(error);
                };
                
                rmsWebSocket.onmessage = function(event) {
                    // Handle ping/pong messages
                    if (event.data === 'pong') {
                        addRmsDebugLine('info', 'Pong received');
                        return;
                    }
                    
                    try {
                        const data = JSON.parse(event.data);
                        handleRmsWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                        addRmsDebugLine('error', `Error parsing message: ${event.data}`);
                    }
                };
                
                rmsWebSocket.onclose = function(event) {
                    console.log('RMS WebSocket disconnected');
                    updateRmsStatus('Disconnected', 'bg-secondary');
                    addRmsDebugLine('warning', 'WebSocket disconnected');
                    
                    // Connection controls have been removed - auto-managed now
                    
                    // Stop ping interval
                    stopRmsPingInterval();
                };
                
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                addRmsDebugLine('error', `Failed to create WebSocket: ${error.message}`);
                reject(error);
            }
        });
    }

    function connectRmsWebSocket(propertyCode) {
        if (rmsWebSocket && rmsWebSocket.readyState === WebSocket.OPEN) {
            disconnectRmsWebSocket();
        }
        
        currentPropertyCode = propertyCode;
        const wsUrl = `ws://${window.location.host}/ws/rms-progress/${propertyCode}`;
        
        try {
            rmsWebSocket = new WebSocket(wsUrl);
            
            rmsWebSocket.onopen = function(event) {
                console.log('RMS WebSocket connected');
                updateRmsStatus('Connected', 'bg-success');
                showRmsDebugPanel();
                addRmsDebugLine('success', 'WebSocket connected successfully');
                
                // Connection controls have been removed - auto-managed now
                
                // Start ping interval
                startRmsPingInterval();
            };
            
            rmsWebSocket.onmessage = function(event) {
                // Handle ping/pong messages
                if (event.data === 'pong') {
                    addRmsDebugLine('info', 'Pong received');
                    return;
                }
                
                try {
                    const data = JSON.parse(event.data);
                    handleRmsWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                    addRmsDebugLine('error', `Error parsing message: ${event.data}`);
                }
            };
            
            rmsWebSocket.onclose = function(event) {
                console.log('RMS WebSocket disconnected');
                updateRmsStatus('Disconnected', 'bg-secondary');
                addRmsDebugLine('warning', 'WebSocket disconnected');
                
                // Connection controls have been removed - auto-managed now
                
                // Stop ping interval
                stopRmsPingInterval();
            };
            
            rmsWebSocket.onerror = function(error) {
                console.error('RMS WebSocket error:', error);
                updateRmsStatus('Error', 'bg-danger');
                addRmsDebugLine('error', 'WebSocket connection error');
            };
            
        } catch (error) {
            console.error('Failed to create WebSocket:', error);
            addRmsDebugLine('error', `Failed to create WebSocket: ${error.message}`);
        }
    }
    
    function disconnectRmsWebSocket() {
        if (rmsWebSocket) {
            rmsWebSocket.close();
            rmsWebSocket = null;
        }
        currentPropertyCode = null;
    }
    
    function pingRmsWebSocket() {
        if (rmsWebSocket && rmsWebSocket.readyState === WebSocket.OPEN) {
            rmsWebSocket.send('ping');
            addRmsDebugLine('info', 'Ping sent');
        }
    }
    
    let rmsPingInterval = null;
    
    function startRmsPingInterval() {
        rmsPingInterval = setInterval(() => {
            if (rmsWebSocket && rmsWebSocket.readyState === WebSocket.OPEN) {
                rmsWebSocket.send('ping');
            }
        }, 30000); // Ping every 30 seconds
    }
    
    function stopRmsPingInterval() {
        if (rmsPingInterval) {
            clearInterval(rmsPingInterval);
            rmsPingInterval = null;
        }
    }
    
    function handleRmsWebSocketMessage(data) {
        // Update progress bar for progress updates
        if (data.type === 'progress_update' && data.progress !== null && data.progress !== undefined) {
            const progressBar = document.getElementById('rms-progress-bar');
            const progressText = document.getElementById('rms-progress-text');
            const progressPercentage = document.getElementById('rms-progress-percentage');
            
            if (progressBar) {
                progressBar.style.width = `${data.progress}%`;
                progressBar.style.backgroundColor = '#007bff';
                progressBar.style.transition = 'width 0.3s ease';
            }
            if (progressText) progressText.textContent = data.message;
            if (progressPercentage) progressPercentage.textContent = `${Math.round(data.progress)}%`;
        }
        
        switch (data.type) {
            case 'connection_established':
                addRmsDebugLine('success', data.message);
                break;
                
            case 'progress_update':
                handleRmsProgressUpdate(data);
                break;
                
            case 'debug_message':
                addRmsDebugLine('info', data.message);
                break;
                
            case 'error':
                addRmsDebugLine('error', `Error at step ${data.step}: ${data.error}`);
                break;
                
            case 'completion':
                handleRmsCompletion(data);
                break;
                
            case 'pong':
                // Silent ping response
                break;
                
            default:
                addRmsDebugLine('info', `Unknown message type: ${data.type}`);
        }
    }
    
    function handleRmsProgressUpdate(data) {
        const step = data.step;
        const message = data.message;
        const progress = data.progress || 0;
        const timestamp = data.timestamp;
        
        // Update progress bar
        updateRmsProgress(progress, message);
        
        // Add debug line
        addRmsDebugLine('info', `[${step.toUpperCase()}] ${message}`);
        
        // Update progress text
        document.getElementById('rms-progress-text').textContent = message;
        document.getElementById('rms-progress-percentage').textContent = `${Math.round(progress)}%`;
    }
    
    function handleRmsCompletion(data) {
        const result = data.result;
        addRmsDebugLine('success', `Generation completed! Batch ID: ${result.batch_id}, Moves: ${result.move_count}`);
        
        // Update progress to 100%
        updateRmsProgress(100, 'Generation completed successfully');
        
        // Auto-disconnect WebSocket after completion
        setTimeout(() => {
            addRmsDebugLine('info', 'Analysis complete - disconnecting...');
            disconnectRmsWebSocket();
        }, 2000); // Wait 2 seconds to let user see completion message
        
        // Don't call loadMoveSuggestions() here - it's already called from the loadMoveSuggestions() function
        // This prevents duplicate batch creation
        console.log('RMS generation completed - suggestions will be fetched by loadMoveSuggestions()');
    }
    
    function updateRmsProgress(progress, message) {
        const progressBar = document.getElementById('rms-progress-bar');
        const progressText = document.getElementById('rms-progress-text');
        const progressPercentage = document.getElementById('rms-progress-percentage');
        
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressText) progressText.textContent = message;
        if (progressPercentage) progressPercentage.textContent = `${Math.round(progress)}%`;
        
        // Update progress bar color based on progress
        if (progress < 30) {
            progressBar.className = 'progress-bar bg-warning';
        } else if (progress < 70) {
            progressBar.className = 'progress-bar bg-info';
        } else if (progress < 100) {
            progressBar.className = 'progress-bar bg-primary';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
    }
    
    function updateRmsStatus(status, badgeClass) {
        const statusBadge = document.getElementById('rms-status-badge');
        statusBadge.textContent = status;
        statusBadge.className = `badge ${badgeClass}`;
    }
    
    function addRmsDebugLine(type, message) {
        const debugOutput = document.getElementById('rms-debug-output');
        const timestamp = new Date().toLocaleTimeString();
        
        const debugLine = document.createElement('div');
        debugLine.className = 'debug-line';
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'timestamp';
        timestampSpan.textContent = `[${timestamp}]`;
        
        const messageSpan = document.createElement('span');
        messageSpan.className = type;
        messageSpan.textContent = message;
        
        debugLine.appendChild(timestampSpan);
        debugLine.appendChild(messageSpan);
        
        debugOutput.appendChild(debugLine);
        
        // Auto-scroll if enabled
        if (rmsAutoScroll) {
            // Scroll the container, not the inner debug output
            const debugContainer = debugOutput.parentElement;
            debugContainer.scrollTop = debugContainer.scrollHeight;
        }
    }
    
    function showRmsDebugPanel() {
        document.getElementById('rms-debug-panel').style.display = 'block';
    }
    
    function closeRmsDebugPanel() {
        document.getElementById('rms-debug-panel').style.display = 'none';
        disconnectRmsWebSocket();
    }
    

    
    // Enhanced move suggestions functions with WebSocket integration
    async function loadMoveSuggestions() {
        if (!authToken) return;

        const propertyFilter = document.getElementById('property-filter').value;
        console.log('Starting loadMoveSuggestions for property:', propertyFilter);
        if (!propertyFilter) {
            alert('Please select a property first.');
            return;
        }

        try {
            // Show loading state
            const loadBtn = document.getElementById('load-moves-btn');
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
            loadBtn.disabled = true;

            // Show debug panel immediately and connect to WebSocket
            showRmsDebugPanel();
            addRmsDebugLine('info', 'Preparing to load move suggestions...');
            
            // Connect to WebSocket for real-time updates and wait for connection
            await connectRmsWebSocketAndWait(propertyFilter);
            
            // Now that WebSocket is connected, start the analysis
            addRmsDebugLine('info', 'Starting move suggestions analysis...');

            // Use the property code directly from the option value
            const propertyCode = propertyFilter;

            if (!propertyCode) {
                alert('Could not determine property code.');
                return;
            }

            console.log(`Loading move suggestions for property code: ${propertyCode}`);

            // Generate new move suggestions from RMS API
            const response = await fetch(`/api/v1/defrag-moves/generate/${propertyCode}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            console.log('Load suggestions API response status:', response.status);

            if (response.ok) {
                const generateData = await response.json();
                console.log('Generate API response data:', generateData);

                // Check if any suggestions were generated in this batch
                const moveCount = generateData.move_count || 0;
                console.log(`✅ Frontend received: Generated ${moveCount} new move suggestions`);
                console.log('✅ Generate API Response Details:', JSON.stringify(generateData, null, 2));

                if (moveCount > 0) {
                    // 🔥 CRITICAL FIX: Use fresh suggestions directly from generate response - NO DATABASE LOOKUP
                    console.log('✅ moveCount > 0, using FRESH suggestions directly from generate response');
                    console.log('✅ Fresh suggestions from RMS API:', generateData.moves);
                    console.log('✅ Calling displayMoveSuggestions with FRESH data...');
                    
                    // Set current property code for chart functionality
                    setCurrentPropertyCode(propertyCode);
                    
                    displayMoveSuggestions({...generateData, propertyCode});
                } else {
                    // No suggestions generated - show "No Move Suggestions Found"
                    console.log('❌ moveCount is 0 - No move suggestions generated - displaying empty state');
                    console.log('❌ Generate API returned move_count:', moveCount);
                    displayNoMoveSuggestions();
                }

                console.log('Updating cache status...');
                updateCacheStatus(generateData);

                console.log('Showing refresh button...');
                showRefreshButton();

                console.log('Load suggestions completed successfully');
            } else {
                const error = await response.json();
                console.error('Load suggestions API error:', error);
                alert(`Failed to load move suggestions: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error loading move suggestions:', error);
            console.error('Error stack:', error.stack);
            alert('Failed to load move suggestions.');
        } finally {
            // Restore button state
            const loadBtn = document.getElementById('load-moves-btn');
            if (loadBtn) {
                loadBtn.innerHTML = '<i class="fas fa-download me-1"></i>Load Move Suggestions';
                loadBtn.disabled = false;
            }
        }
    }
    
    async function refreshMoveSuggestions() {
        if (!authToken) return;

        const propertyFilter = document.getElementById('property-filter').value;
        console.log('Starting refreshMoveSuggestions for property:', propertyFilter);
        if (!propertyFilter) {
            alert('Please select a property first.');
            return;
        }

        try {
            // Show loading state
            const refreshBtn = document.getElementById('refresh-moves-btn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
            refreshBtn.disabled = true;

            // Show debug panel immediately and connect to WebSocket
            showRmsDebugPanel();
            addRmsDebugLine('info', 'Preparing to refresh move suggestions...');
            
            // Connect to WebSocket for real-time updates and wait for connection
            await connectRmsWebSocketAndWait(propertyFilter);
            
            // Now that WebSocket is connected, start the analysis
            addRmsDebugLine('info', 'Starting fresh move suggestions analysis...');

            // Use the property code directly from the option value
            const propertyCode = propertyFilter;

            if (!propertyCode) {
                alert('Could not determine property code.');
                return;
            }

            console.log(`Refreshing move suggestions for property code: ${propertyCode}`);

            // Call the generate endpoint to get fresh suggestions
            const response = await fetch(`/api/v1/defrag-moves/generate/${propertyCode}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    force_refresh: true
                })
            });

            console.log('Refresh suggestions API response status:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('Refresh suggestions API response data:', data);

                console.log('Refresh suggestions completed - move data will be displayed by loadMoveSuggestions()');
                // Don't call loadMoveSuggestions() here - it causes duplicate batch creation

                console.log('Refresh suggestions completed successfully');
            } else {
                const error = await response.json();
                console.error('Refresh suggestions API error:', error);
                alert(`Failed to refresh move suggestions: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error refreshing move suggestions:', error);
            console.error('Error stack:', error.stack);
            alert('Failed to refresh move suggestions.');
        } finally {
            // Restore button state
            const refreshBtn = document.getElementById('refresh-moves-btn');
            if (refreshBtn) {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }
    }

        function displayMoveSuggestions(data) {
            console.log('displayMoveSuggestions called with data:', data);
            
            // Use the enhanced checkbox-enabled display function
            displayMoveSuggestionsWithCheckboxes(data);
        }

        function displayNoMoveSuggestions() {
            console.log('displayNoMoveSuggestions called - showing empty state');
            
            const movesContainer = document.getElementById('moves-container');
            if (!movesContainer) {
                console.error('Moves container not found');
                return;
            }
            
            // Clear any existing content
            movesContainer.innerHTML = '';
            
            // Show "No Move Suggestions Found" message
            movesContainer.innerHTML = `
                <div class="alert alert-info text-center" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>No Move Suggestions Found</strong>
                    <p class="mb-0 mt-2">The analysis found no optimization opportunities for this property at this time.</p>
                    <p class="mb-0">This could mean:</p>
                    <ul class="list-unstyled mt-2">
                        <li>• All reservations are optimally placed</li>
                        <li>• No short stays that can be moved</li>
                        <li>• Property is fully booked with no alternative units available</li>
                    </ul>
                </div>
            `;
            
            // Also clear the move actions bar
            updateMoveSelectionUI();
        }

        function updateCacheStatus(data) {
            console.log('updateCacheStatus called with data:', data);
            
            try {
                const cacheStatusElement = document.getElementById('cache-status');
                if (!cacheStatusElement) {
                    console.error('Cache status element not found');
                    return;
                }
                
                if (!data || typeof data.cache_age_hours === 'undefined') {
                    console.log('No cache age data available');
                    cacheStatusElement.textContent = 'Unknown';
                    cacheStatusElement.className = 'badge bg-secondary';
                    return;
                }
                
                const isFresh = data.cache_age_hours < 1;
                console.log(`Cache age: ${data.cache_age_hours} hours, is fresh: ${isFresh}`);
                
                if (isFresh) {
                    cacheStatusElement.textContent = 'Fresh';
                    cacheStatusElement.className = 'badge bg-success';
                } else {
                    cacheStatusElement.textContent = 'Stale';
                    cacheStatusElement.className = 'badge bg-warning';
                }
                
                console.log('Cache status updated successfully');
                
            } catch (error) {
                console.error('Error in updateCacheStatus:', error);
                console.error('Error stack:', error.stack);
            }
        }

        function showRefreshButton() {
            document.getElementById('load-moves-btn').style.display = 'none';
            document.getElementById('refresh-moves-btn').style.display = 'block';
        }
        
        function showLoadButton() {
            document.getElementById('load-moves-btn').style.display = 'block';
            document.getElementById('refresh-moves-btn').style.display = 'none';
        }

        function getStrategicImportanceColor(importance) {
            if (!importance || importance === 'unknown') return 'secondary';
            switch (importance.toLowerCase()) {
                case 'high': return 'dhp-high';
                case 'medium': return 'dhp-medium';
                case 'low': return 'dhp-low';
                default: return 'secondary';
            }
        }

        function getScoreColor(score) {
            if (score >= 80) return 'success';
            if (score >= 60) return 'warning';
            return 'danger';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            // Check if user is already logged in with a valid token
            const savedToken = localStorage.getItem('authToken');
            console.log('Saved token found:', !!savedToken);
            
            if (savedToken) {
                console.log('Attempting auto-login with saved token...');
                // Verify the token is still valid before auto-login
                verifyTokenAndLogin(savedToken);
            } else {
                console.log('No saved token, showing login page');
            }
        });

        // Verify token and auto-login if valid
        async function verifyTokenAndLogin(token) {
            try {
                console.log('verifyTokenAndLogin called with token:', token ? token.substring(0, 20) + '...' : 'No token');
                const response = await fetch('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    console.log('Auto-login successful for user:', user.username);
                    authToken = token;
                    currentUser = user;
                    showMainApp();
                    loadUserInfo();
                    refreshMoves();
                    // Start session timer for auto-login
                    startSessionTimer();
                } else {
                    // Token is invalid, remove it and show login
                    localStorage.removeItem('authToken');
                    console.log('Invalid token found, showing login page');
                }
            } catch (error) {
                // Error occurred, remove token and show login
                localStorage.removeItem('authToken');
                console.error('Error verifying token:', error);
            }
        }

        // Force logout and show login screen (useful for testing)
        function forceLogout() {
            console.log('Force logout called');
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            showLogin();
        }

        // Move Selection and Processing Functions
        let selectedMoves = new Set();

        function handleMoveSelection(moveId, action) {
            // Remove any previous selection for this move
            selectedMoves.forEach(existingKey => {
                if (existingKey.startsWith(`${moveId}-`)) {
                    selectedMoves.delete(existingKey);
                }
            });
            
            // Add new selection if action is not empty
            if (action) {
                const key = `${moveId}-${action}`;
                selectedMoves.add(key);
            }
            
            updateMoveSelectionUI();
        }

        function updateMoveSelectionUI() {
            const selectedCount = selectedMoves.size;
            const selectedCountElement = document.getElementById('selected-count');
            const processBtn = document.getElementById('process-btn');
            const actionsBar = document.getElementById('move-actions-bar');
            
            if (selectedCountElement) selectedCountElement.textContent = selectedCount;
            if (processBtn) processBtn.disabled = selectedCount === 0;
            if (actionsBar) actionsBar.style.display = selectedCount > 0 ? 'block' : 'none';
        }

        function clearSelection() {
            selectedMoves.clear();
            updateMoveSelectionUI();
            
            // Uncheck all checkboxes
            document.querySelectorAll('input[name^="move-"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        async function processSelectedMoves() {
            if (selectedMoves.size === 0) {
                alert('No moves selected');
                return;
            }

            const processData = [];
            selectedMoves.forEach(key => {
                const [moveId, action] = key.split('-');
                processData.push({
                    move_id: parseInt(moveId),
                    action: action
                });
            });

            try {
                const response = await fetch('/api/v1/defrag-moves/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ moves: processData })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Successfully processed ${result.total_processed} moves and rejected ${result.total_rejected} moves`);
                    
                    // Clear selection and refresh display
                    clearSelection();
                    refreshMoves();
                } else {
                    const error = await response.json();
                    alert(`Error processing moves: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error processing moves:', error);
                alert('Error processing moves. Please try again.');
            }
        }

        function showMoveHistory() {
            // Redirect to the move history page
            window.location.href = '/move-history';
        }

        function showDefinitions() {
            // Show the definitions modal
            const modal = new bootstrap.Modal(document.getElementById('definitionsModal'));
            modal.show();
        }

        // Enhanced move display function with checkboxes
        function displayMoveSuggestionsWithCheckboxes(data) {
            try {
                const container = document.getElementById('moves-container');
                if (!container) {
                    console.error('Moves container not found');
                    return;
                }

                if (!data.moves || data.moves.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>No move suggestions available</p>
                        </div>
                    `;
                    return;
                }

                const tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover table-sm table-dhp" style="font-size: 0.85rem;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">Select</th>
                                    <th style="width: 50px;">Order</th>
                                    <th style="width: 90px;">From Unit</th>
                                    <th style="width: 90px;">To Unit</th>
                                    <th style="width: 120px;">Guest</th>
                                    <th style="width: 80px;">Res#</th>
                                    <th style="width: 85px;">Check-in</th>
                                    <th style="width: 85px;">Check-out</th>
                                    <th style="width: 70px;">Freed Nights</th>
                                    <th style="width: 80px;">Importance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(() => {
                                    // Group moves by category
                                    const groupedMoves = {};
                                    data.moves.forEach((move, index) => {
                                        const category = move.category || 'Uncategorized';
                                        if (!groupedMoves[category]) {
                                            groupedMoves[category] = [];
                                        }
                                        groupedMoves[category].push({ ...move, originalIndex: index });
                                    });
                                    
                                    // Function to get appropriate icon for accommodation category
                                    function getCategoryIcon(category) {
                                        const categoryLower = category.toLowerCase();
                                        if (categoryLower.includes('cabin') || categoryLower.includes('cottage')) {
                                            return 'fas fa-home';
                                        } else if (categoryLower.includes('studio')) {
                                            return 'fas fa-building';
                                        } else if (categoryLower.includes('deluxe') || categoryLower.includes('luxury')) {
                                            return 'fas fa-crown';
                                        } else if (categoryLower.includes('economy') || categoryLower.includes('standard')) {
                                            return 'fas fa-bed';
                                        } else if (categoryLower.includes('villa')) {
                                            return 'fas fa-house-user';
                                        } else if (categoryLower.includes('apartment') || categoryLower.includes('suite')) {
                                            return 'fas fa-door-open';
                                        } else if (categoryLower.includes('pet') || categoryLower.includes('friendly')) {
                                            return 'fas fa-paw';
                                        } else {
                                            return 'fas fa-map-marker-alt';
                                        }
                                    }
                                    
                                    // Generate HTML for each category
                                    let html = '';
                                    Object.keys(groupedMoves).sort().forEach((category, categoryIndex) => {
                                        // Add category header row with chart toggle button
                                        html += `
                                            <tr class="table-secondary">
                                                <td colspan="10" class="fw-bold text-start ps-3">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="${getCategoryIcon(category)} me-2 text-primary"></i>${category}
                                                        </div>
                                                                                                <button type="button" class="btn btn-xs btn-outline-primary" 
                                                onclick="toggleCategoryChart('${category}', ${categoryIndex}, '${data.propertyCode || 'UNKNOWN'}')"
                                                id="chart-toggle-${categoryIndex}">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            Show Chart
                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                        
                                        // Add moves for this category with category-relative ordering
                                        groupedMoves[category].forEach((move, categoryIndex) => {
                                            // Extract the category-relative move number from sequential_order (e.g., "1.3" -> "3")
                                            let categoryMoveNumber = categoryIndex + 1; // fallback
                                            if (move.sequential_order && move.sequential_order.includes('.')) {
                                                const parts = move.sequential_order.split('.');
                                                if (parts.length === 2) {
                                                    categoryMoveNumber = parts[1];
                                                }
                                            }
                                            
                                            html += `
                                                <tr>
                                                    <td>
                                                        <select class="form-select form-select-sm" id="move-select-${move.id}" onchange="handleMoveSelection(${move.id}, this.value)">
                                                            <option value="">—</option>
                                                            <option value="accept" class="text-success">✓ Accept</option>
                                                            <option value="reject" class="text-danger">✗ Reject</option>
                                                        </select>
                                                    </td>
                                                    <td><small><strong>${categoryMoveNumber}</strong></small></td>
                                                    <td><small><code>${move.from_unit || 'N/A'}</code></small></td>
                                                    <td><small><code>${move.to_unit || 'N/A'}</code></small></td>
                                                    <td><small>${move.guest || 'N/A'}</small></td>
                                                    <td><small><code>${move.reservation_id || 'N/A'}</code></small></td>
                                                    <td><small>${move.check_in || 'N/A'}</small></td>
                                                    <td><small>${move.check_out || 'N/A'}</small></td>
                                                    <td class="text-center">
                                                        <span class="badge bg-info text-dark">
                                                            ${move.nights_freed || 0}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-${getStrategicImportanceColor(move.strategic_importance || 'unknown')}">
                                                            ${move.strategic_importance || 'N/A'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `;
                                        });
                                        
                                        // Add chart container row AFTER all moves (hidden by default)
                                        html += `
                                            <tr id="chart-row-${categoryIndex}" style="display: none;">
                                                <td colspan="10" class="p-0">
                                                    <div class="category-chart-wrapper">
                                                        <div id="category-chart-${categoryIndex}" class="category-chart-container">
                                                            <!-- Chart will be dynamically loaded here -->
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    });
                                    return html;
                                })()}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        Analysis Date: ${data.analysis_date ? new Date(data.analysis_date).toLocaleString() : 'N/A'} | 
                        Property: ${data.property_code || 'N/A'}
                    </div>
                `;
                
                container.innerHTML = tableHtml;
                console.log('Move suggestions with checkboxes displayed successfully');
                
            } catch (error) {
                console.error('Error in displayMoveSuggestionsWithCheckboxes:', error);
                container.innerHTML = `
                    <div class="text-center text-danger py-5">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Error displaying move suggestions</p>
                        <small class="text-muted">Please try refreshing the page</small>
                    </div>
                `;
            }
        }
        
        // Global chart management
        let categoryCharts = {};

        // Toggle category chart display
        async function toggleCategoryChart(category, categoryIndex, propertyCode) {
            const chartRow = document.getElementById(`chart-row-${categoryIndex}`);
            const chartContainer = document.getElementById(`category-chart-${categoryIndex}`);
            const toggleButton = document.getElementById(`chart-toggle-${categoryIndex}`);
            
            console.log('toggleCategoryChart called with:', { category, categoryIndex, propertyCode });
            
            if (!chartRow || !chartContainer || !toggleButton) {
                console.error('Chart elements not found');
                return;
            }
            
            if (chartRow.style.display === 'none') {
                // Show chart
                chartRow.style.display = '';
                toggleButton.innerHTML = '<i class="fas fa-calendar-alt me-1"></i>Hide Chart';
                toggleButton.classList.remove('btn-outline-primary');
                toggleButton.classList.add('btn-primary');
                
                // Load chart if not already loaded
                if (!categoryCharts[categoryIndex]) {
                    await loadCategoryChart(category, categoryIndex, propertyCode);
                }
            } else {
                // Hide chart
                chartRow.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-calendar-alt me-1"></i>Show Chart';
                toggleButton.classList.remove('btn-primary');
                toggleButton.classList.add('btn-outline-primary');
            }
        }

        // Load chart data for specific category
        async function loadCategoryChart(category, categoryIndex, propertyCode) {
            const chartContainer = document.getElementById(`category-chart-${categoryIndex}`);
            
            console.log('loadCategoryChart called with:', { category, categoryIndex, propertyCode });
            
            if (!chartContainer) {
                console.error('Chart container not found:', `category-chart-${categoryIndex}`);
                return;
            }
            
            if (!propertyCode) {
                console.error('Property code not provided. Current value:', propertyCode);
                return;
            }
            
            try {
                // Show loading state
                chartContainer.innerHTML = `
                    <div class="chart-loading">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading booking chart for ${category}...
                    </div>
                `;
                
                // Create unique container ID for this category
                const uniqueContainerId = `chart-content-${categoryIndex}`;
                chartContainer.innerHTML = `<div id="${uniqueContainerId}"></div>`;
                
                // Create and load chart
                const chart = new BookingChart(uniqueContainerId, {
                    showTooltips: true,
                    allowToggle: false  // We handle toggling at category level
                });
                
                console.log('About to call chart.loadChart with propertyCode:', propertyCode);
                await chart.loadChart(propertyCode);
                console.log('chart.loadChart completed. Chart data:', chart.chartData);
                
                // Filter chart data to show only this category
                if (chart.chartData && chart.chartData.categories) {
                    console.log('Original categories:', chart.chartData.categories.map(c => c.name));
                    chart.chartData.categories = chart.chartData.categories.filter(
                        cat => cat.name === category
                    );
                    console.log('Filtered categories for', category, ':', chart.chartData.categories.map(c => c.name));
                    chart.renderChart();
                    
                    // Expand the category by default
                    setTimeout(() => {
                        const categoryGrid = chart.container.querySelector('.chart-grid');
                        if (categoryGrid) {
                            categoryGrid.classList.add('show');
                        }
                    }, 100);
                    
                    console.log(`Chart loaded and rendered for category: ${category}`);
                } else {
                    console.error(`No chart data loaded for category: ${category}. Chart data:`, chart.chartData);
                    chartContainer.innerHTML = `
                        <div class="chart-error">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No chart data available for ${category}
                        </div>
                    `;
                }
                
                // Store chart instance
                categoryCharts[categoryIndex] = chart;
                
            } catch (error) {
                console.error('Error loading category chart:', error);
                chartContainer.innerHTML = `
                    <div class="chart-error">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load booking chart. Please try again.
                    </div>
                `;
            }
        }

        // Update current property code when move suggestions are loaded
        function setCurrentPropertyCode(propertyCode) {
            currentPropertyCode = propertyCode;
            
            // Clear existing charts when property changes
            Object.values(categoryCharts).forEach(chart => {
                if (chart && chart.destroy) {
                    chart.destroy();
                }
            });
            categoryCharts = {};
        }

        // Handle debug panel toggle icon rotation
        document.addEventListener('DOMContentLoaded', function() {
            const debugCollapse = document.getElementById('debug-collapse');
            const toggleIcon = document.getElementById('debug-toggle-icon');
            
            if (debugCollapse && toggleIcon) {
                debugCollapse.addEventListener('show.bs.collapse', function() {
                    toggleIcon.className = 'fas fa-chevron-up';
                });
                
                debugCollapse.addEventListener('hide.bs.collapse', function() {
                    toggleIcon.className = 'fas fa-chevron-down';
                });
            }
        });
    </script>
    
    <!-- Booking Chart Component -->
    <script src="/static/js/booking-chart.js"></script>
</body>
</html>
