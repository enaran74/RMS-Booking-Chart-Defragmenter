<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - RMS Booking Chart Defragmenter - Discovery Holiday Parks</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/dhp_circle_logo.svg">
    <link rel="icon" type="image/png" href="/static/images/dhp_circle_logo.svg">
    <link rel="shortcut icon" href="/static/images/dhp_circle_logo.svg">
    <!-- Cache buster: v1.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/styles/theme.css" rel="stylesheet">
    <style>
        /* Align setup nav and buttons with DHP theme */
        .nav-pills.nav-setup .nav-link { color: var(--dhp-brand-blue); }
        .nav-pills.nav-setup .nav-link:hover { color: var(--dhp-brand-green); }
        .nav-pills.nav-setup .nav-link.active {
            background: linear-gradient(135deg, var(--dhp-brand-blue) 0%, var(--dhp-brand-teal) 100%);
            color: #fff;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .property-badge {
            font-size: 0.8em;
        }
        
        /* Discovery Holiday Parks Theme */
        .navbar-dhp {
            background: linear-gradient(135deg, #1e6091 0%, #2e8b9b 100%) !important;
            border-bottom: 3px solid #00a650;
        }
        
        .dhp-logo {
            height: 40px;
            margin-right: 10px;
        }
        
        /* Database Table Styling - Compact Database Management Interface */
        .database-table-container {
            max-height: 400px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #fff;
        }
        
        .database-table {
            width: 100%;
            margin: 0;
            font-size: 11px;
            font-family: 'Courier New', Consolas, monospace;
            border-collapse: collapse;
        }
        
        .database-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 4px 8px;
            font-weight: 600;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-size: 10px;
            text-transform: uppercase;
            color: #495057;
        }
        
        .database-table td {
            border: 1px solid #dee2e6;
            padding: 3px 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            vertical-align: top;
        }
        
        .database-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .database-table tbody tr:hover {
            background-color: #e9ecef;
        }
        
        .database-table td[title] {
            cursor: help;
        }
        
        .table-records-view {
            border-top: 2px solid #007bff;
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-records-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 4px 4px 0 0;
            margin: -15px -15px 10px -15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-records-header h6 {
            margin: 0;
            font-weight: 600;
        }
        
        .records-count-badge {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
    </style>
    <meta name="use-training-db" content="{{ 'true' if use_training_db else 'false' }}">
</head>
<body>
    {% set active_page = 'setup' %}
    {% include 'components/header.html' %}

    <div class="container-fluid container-fluid-edge mt-4">
        <!-- Admin Access Check -->
        <div class="d-none" id="admin-access">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>System Setup</h4>
                                    <p class="text-muted mb-0">Administrative functions for system configuration and monitoring</p>
                                </div>
                                <a href="/" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Navigation Pills -->
                            <ul class="nav nav-pills nav-setup mb-4" id="setupTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="properties-tab" data-bs-toggle="pill" data-bs-target="#properties-content" type="button" role="tab">
                                        <i class="fas fa-building me-2"></i>Properties
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="database-tab" data-bs-toggle="pill" data-bs-target="#database-content" type="button" role="tab">
                                        <i class="fas fa-database me-2"></i>Database Management
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="user-properties-tab" data-bs-toggle="pill" data-bs-target="#user-properties-content" type="button" role="tab">
                                        <i class="fas fa-users me-2"></i>User-Property Management
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="environment-tab" data-bs-toggle="pill" data-bs-target="#environment-content" type="button" role="tab">
                                        <i class="fas fa-cog me-2"></i>Environment Configuration
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="setupTabContent">
                                <!-- Properties Tab -->
                                <div class="tab-pane fade show active" id="properties-content" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Properties Management</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <button id="refresh-properties-btn" class="btn btn-dhp-primary btn-sm w-100 mb-2" onclick="refreshProperties()">
                                                            <i class="fas fa-sync-alt me-1"></i>Refresh from RMS
                                                        </button>
                                                        <div id="properties-info" class="text-muted small">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            <span id="properties-count">0</span> properties loaded
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="show-active-only" checked>
                                                            <label class="form-check-label" for="show-active-only">
                                                                Show active properties only
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Properties List</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="properties-list" class="small">
                                                        <!-- Properties will be populated dynamically -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Database Management Tab -->
                                <div class="tab-pane fade" id="database-content" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-0"><i class="fas fa-database me-2"></i>Database Tables</h6>
                                                            <p class="text-muted mb-0">View database structure and records (read-only)</p>
                                                        </div>
                                                        <button class="btn btn-outline-primary btn-sm" onclick="refreshDatabaseInfo()">
                                                            <i class="fas fa-sync-alt me-1"></i>Refresh Database Info
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="database-tables">
                                                        <div class="text-center text-muted py-5">
                                                            <i class="fas fa-database fa-2x mb-3"></i>
                                                            <p>Click "Refresh Database Info" to load table information</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- User-Property Management Tab -->
                                <div class="tab-pane fade" id="user-properties-content" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-plus me-2"></i>Assign Properties</h6>
                                                </div>
                                                <div class="card-body">
                                                    <form id="assign-property-form">
                                                        <div class="mb-3">
                                                            <label for="assign-user" class="form-label">User</label>
                                                            <select class="form-select" id="assign-user" required>
                                                                <option value="">Select User</option>
                                                                <!-- Users will be populated dynamically -->
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="assign-property" class="form-label">Property</label>
                                                            <select class="form-select" id="assign-property" required>
                                                                <option value="">Select Property</option>
                                                                <!-- Properties will be populated dynamically -->
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox" id="assign-primary">
                                                                <label class="form-check-label" for="assign-primary">
                                                                    Set as Primary Property
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <button type="submit" class="btn btn-primary btn-sm w-100">
                                                            <i class="fas fa-plus me-1"></i>Assign Property
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Current Assignments</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="user-properties-list">
                                                        <div class="text-center text-muted py-5">
                                                            <i class="fas fa-users fa-2x mb-3"></i>
                                                            <p>No user-property assignments found</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0"><i class="fas fa-users-cog me-2"></i>Users Management</h6>
                                                    <button class="btn btn-sm btn-dhp-primary" onclick="openUserModal()">
                                                        <i class="fas fa-user-plus me-1"></i>Add User
                                                    </button>
                                                </div>
                                                <div class="card-body">
                                                    <div id="users-list">
                                                        <div class="text-muted">Loading users...</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Environment Configuration Tab -->
                                <div class="tab-pane fade" id="environment-content" role="tabpanel">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Environment Configuration</h6>
                                                            <p class="text-muted mb-0">Configure environment variables for the entire system</p>
                                                        </div>
                                                        <div>
                                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="loadEnvironmentVariables()">
                                                                <i class="fas fa-sync-alt me-1"></i>Reload
                                                            </button>
                                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="testRmsConnectionFromConfig()">
                                                                <i class="fas fa-flask me-1"></i>Test RMS API
                                                            </button>
                                                            <button class="btn btn-outline-success btn-sm me-2" onclick="testChatGptConnectionFromConfig()">
                                                                <i class="fas fa-robot me-1"></i>Test ChatGPT API
                                                            </button>
                                                            <button class="btn btn-dhp-primary btn-sm" onclick="saveEnvironmentVariables()">
                                                                <i class="fas fa-save me-1"></i>Save Configuration
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div id="environment-form">
                                                        <div class="text-center text-muted py-5">
                                                            <i class="fas fa-cog fa-2x mb-3"></i>
                                                            <p>Click "Reload" to load current environment configuration</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Non-Admin Access Message -->
        <div class="d-none" id="non-admin-access">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                            <h5>Access Restricted</h5>
                            <p class="text-muted">This page is only accessible to administrators.</p>
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-home me-2"></i>Return to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <!-- User Add/Edit Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userModalTitle">Add User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="user-form">
              <input type="hidden" id="user-id">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Username</label>
                  <input class="form-control" id="user-username" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="user-email" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Password</label>
                  <input type="password" class="form-control" id="user-password" placeholder="Set or reset">
                  <small class="text-muted">Min 8 chars, at least 1 uppercase and 1 special character</small>
                </div>
                <div class="col-md-4">
                  <label class="form-label">First Name</label>
                  <input class="form-control" id="user-first-name">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Last Name</label>
                  <input class="form-control" id="user-last-name">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <div class="form-check me-3">
                    <input class="form-check-input" type="checkbox" id="user-is-admin">
                    <label class="form-check-label" for="user-is-admin">Admin</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="user-is-active" checked>
                    <label class="form-check-label" for="user-is-active">Active</label>
                  </div>
                </div>
              </div>
              <hr>
              <div>
                <label class="form-label">Property Access</label>
                <div class="small text-muted mb-2">Admins can see all properties; for non-admins select allowed properties and choose a primary.</div>
                <div id="user-properties-selector" class="row g-2"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <div class="me-auto">
              <label class="btn btn-sm btn-outline-primary mb-0">
                <i class="fas fa-image me-1"></i> Upload Avatar
                <input type="file" id="user-avatar-file" accept="image/*" hidden>
              </label>
              <small class="text-muted ms-2">PNG/JPG up to 1.5MB</small>
            </div>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-dhp-primary" onclick="saveUser()"><i class="fas fa-save me-1"></i>Save</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let authToken = null;
        let currentUser = null;

        // Check authentication and user role on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
        });

        async function checkAuth() {
            console.log('checkAuth called');
            const token = localStorage.getItem('authToken');
            console.log('Token from localStorage:', token ? token.substring(0, 20) + '...' : 'No token found');
            
            if (!token) {
                console.log('No token found, showing non-admin access');
                showNonAdminAccess();
                return;
            }

            try {
                console.log('Making API call to /api/v1/auth/me');
                const response = await fetch('/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('API response status:', response.status);

                if (response.ok) {
                    const user = await response.json();
                    console.log('User data received:', user);
                    console.log('User is_admin:', user.is_admin);
                    
                    if (user.is_admin) {
                        console.log('User is admin, showing admin access');
                        authToken = token;
                        currentUser = user;
                        showAdminAccess();
                        loadUserInfo();
                        loadProperties();
                    } else {
                        console.log('User is not admin, showing non-admin access');
                        showNonAdminAccess();
                    }
                } else {
                    console.log('API call failed, showing non-admin access');
                    showNonAdminAccess();
                }
            } catch (error) {
                console.error('Error checking authentication:', error);
                showNonAdminAccess();
            }
        }

        function showAdminAccess() {
            document.getElementById('loading-state').classList.add('d-none');
            document.getElementById('non-admin-access').classList.add('d-none');
            document.getElementById('admin-access').classList.remove('d-none');
            
            // Load initial data for admin access
            loadProperties();
            
            // Load users and properties for User-Property Management
            loadUsersAndProperties();
            
            // Load initial assignments to show current state
            loadInitialAssignments();
        }

        function showNonAdminAccess() {
            document.getElementById('loading-state').classList.add('d-none');
            document.getElementById('non-admin-access').classList.remove('d-none');
        }

        function loadUserInfo() {
            document.getElementById('username').textContent = currentUser.username;
        }

        // Properties Management Functions
        async function refreshProperties() {
            if (!authToken) return;
            
            const button = document.querySelector('#refresh-properties-btn');
            if (!button) {
                console.error('Refresh button not found');
                return;
            }
            
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
                button.disabled = true;
                
                console.log('Starting properties refresh...');
                const response = await fetch('/api/v1/properties/refresh', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Refresh response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Refresh successful:', result);
                    showAlert('success', 'Properties refreshed successfully from RMS API');
                    
                    console.log('Loading updated properties...');
                    await loadProperties();
                    console.log('Properties loaded successfully');
                } else {
                    const error = await response.json();
                    console.error('Refresh failed:', error);
                    showAlert('danger', `Failed to refresh properties: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error refreshing properties:', error);
                showAlert('danger', 'Error refreshing properties');
            } finally {
                console.log('Restoring button state...');
                button.innerHTML = originalText;
                button.disabled = false;
                console.log('Button state restored');
            }
        }

        async function loadProperties() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/v1/properties/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const properties = await response.json();
                    updatePropertiesInfo(properties);
                    displayPropertiesList(properties);
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }

        function updatePropertiesInfo(properties) {
            const countElement = document.getElementById('properties-count');
            countElement.textContent = properties.length;
        }
        
        function displayPropertiesList(properties) {
            const propertiesListElement = document.getElementById('properties-list');
            const showActiveOnly = document.getElementById('show-active-only').checked;
            
            let filteredProperties = properties;
            if (showActiveOnly) {
                filteredProperties = properties.filter(prop => prop.is_active);
            }
            
            if (filteredProperties.length === 0) {
                propertiesListElement.innerHTML = '<div class="text-muted">No properties to display</div>';
                return;
            }
            
            const propertiesHtml = filteredProperties.map(prop => {
                const statusBadge = prop.is_active 
                    ? '<span class="badge bg-success property-badge">Active</span>'
                    : '<span class="badge bg-secondary property-badge">Inactive</span>';
                
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>${prop.property_code}</strong><br>
                            <small class="text-muted">${prop.property_name}</small>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    </div>
                `;
            }).join('');
            
            propertiesListElement.innerHTML = propertiesHtml;
        }

        // Database Management Functions
        async function refreshDatabaseInfo() {
            console.log('🔄 refreshDatabaseInfo() called');
            console.log('authToken available:', !!authToken);
            
            if (!authToken) {
                console.error('❌ No auth token available');
                showAlert('danger', 'Authentication required. Please refresh the page.');
                return;
            }
            
            try {
                console.log('📡 Making API call to /api/v1/setup/database/tables');
                const response = await fetch('/api/v1/setup/database/tables', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('📡 API response status:', response.status);
                console.log('📡 API response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Database tables data received:', data);
                    displayDatabaseTables(data.tables);
                } else {
                    console.error('❌ API response not ok:', response.status);
                    showAlert('danger', 'Failed to load database information');
                }
            } catch (error) {
                console.error('❌ Error loading database info:', error);
                showAlert('danger', 'Error loading database information');
            }
        }

        function displayDatabaseTables(tables) {
            console.log('🎨 displayDatabaseTables called with:', tables);
            console.log('🎨 tables type:', typeof tables);
            console.log('🎨 tables is array:', Array.isArray(tables));
            console.log('🎨 tables length:', tables ? tables.length : 'undefined');
            
            const container = document.getElementById('database-tables');
            console.log('🎨 container element found:', !!container);
            
            if (!tables || !Array.isArray(tables) || tables.length === 0) {
                console.log('❌ No tables to display - showing "No tables found"');
                container.innerHTML = '<div class="text-muted">No tables found</div>';
                return;
            }
            
            console.log('✅ Processing', tables.length, 'tables for display');
            
            const tablesHtml = tables.map(table => `
                <div class="card mb-3">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-table me-2"></i>${table.name}
                                <span class="badge bg-info ms-2">${table.record_count} records</span>
                            </h6>
                            <div class="btn-group" role="group">
                                ${table.record_count > 0 ? `
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadTableRecords('${table.name}', 0, 50)">
                                        <i class="fas fa-eye me-1"></i>View Records
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteAllRecords('${table.name}')">
                                        <i class="fas fa-trash me-1"></i>Delete All
                                    </button>
                                ` : `
                                    <span class="text-muted">No records</span>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="card-body" style="display: none;">
                        <!-- Table records will be inserted here -->
                    </div>
                </div>
            `).join('');
            
            console.log('🎨 Generated HTML length:', tablesHtml.length);
            console.log('🎨 Container before update:', container.innerHTML.substring(0, 200) + '...');
            console.log('🎨 Setting container innerHTML...');
            container.innerHTML = tablesHtml;
            console.log('🎨 Container after update:', container.innerHTML.substring(0, 200) + '...');
            console.log('🎨 Container innerHTML set successfully');
        }

        // Load Table Records Function
        async function loadTableRecords(tableName, offset = 0, limit = 50) {
            console.log(`📊 Loading records for table: ${tableName}`);
            
            if (!authToken) {
                console.error('❌ No auth token available');
                showAlert('danger', 'Authentication required. Please refresh the page.');
                return;
            }
            
            try {
                console.log(`📡 Making API call to /api/v1/setup/database/table/${tableName}/records`);
                const response = await fetch(`/api/v1/setup/database/table/${tableName}/records?offset=${offset}&limit=${limit}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('📡 API response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Table records data received:', data);
                    displayTableRecords(tableName, data);
                } else {
                    console.error('❌ API response not ok:', response.status);
                    showAlert('danger', `Failed to load records for table: ${tableName}`);
                }
            } catch (error) {
                console.error('❌ Error loading table records:', error);
                showAlert('danger', 'Error loading table records');
            }
        }

        function displayTableRecords(tableName, data) {
            console.log(`🎨 Displaying records for table: ${tableName}`);
            
            // Find the table card container
            const tableCards = document.querySelectorAll('.card');
            let targetCard = null;
            
            for (const card of tableCards) {
                const cardTitle = card.querySelector('h6');
                if (cardTitle && cardTitle.textContent.includes(tableName)) {
                    targetCard = card;
                    break;
                }
            }
            
            if (!targetCard) {
                showAlert('danger', `Could not find table card for ${tableName}`);
                return;
            }
            
            // Remove any existing table view
            const existingTableView = targetCard.querySelector('.table-records-view');
            if (existingTableView) {
                existingTableView.remove();
            }
            
            if (data.records && data.records.length > 0) {
                // Get column names from first record
                const columns = Object.keys(data.records[0]);
                
                // Create inline table view HTML
                const tableViewHTML = `
                    <div class="table-records-view mt-3">
                        <div class="table-records-header">
                            <h6><i class="fas fa-table me-2"></i>Table Records: ${tableName}</h6>
                            <div class="d-flex align-items-center">
                                <span class="records-count-badge me-2">${data.records.length} of ${data.total_count}</span>
                                <button type="button" class="btn btn-sm btn-light" onclick="hideTableRecords('${tableName}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="database-table-container">
                            <table class="database-table">
                                <thead>
                                    <tr>
                                        ${columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.records.map((record, index) => `
                                        <tr>
                                            ${columns.map(col => `<td title="${record[col] || 'null'}">${record[col] || '<span class="text-muted">null</span>'}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${data.has_more ? `
                            <div class="mt-2 text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadMoreRecords('${tableName}')">
                                    <i class="fas fa-plus"></i> Load More Records
                                </button>
                                <small class="text-muted ms-2">Load next 50 records</small>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Show the card body and add table view
                const cardBody = targetCard.querySelector('.card-body');
                cardBody.style.display = 'block';
                cardBody.innerHTML = tableViewHTML;
                
                // Update the View Records button to show "Hide Records"
                const viewButton = targetCard.querySelector('.btn[onclick*="loadTableRecords"]');
                if (viewButton) {
                    viewButton.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Records';
                    viewButton.onclick = () => hideTableRecords(tableName);
                }
                
                showAlert('success', `Loaded ${data.records.length} records from ${tableName}`);
                console.table(data.records);
            } else {
                showAlert('info', `No records found in table: ${tableName}`);
            }
        }
        
        function hideTableRecords(tableName) {
            // Find the table card container
            const tableCards = document.querySelectorAll('.card');
            let targetCard = null;
            
            for (const card of tableCards) {
                const cardTitle = card.querySelector('h6');
                if (cardTitle && cardTitle.textContent.includes(tableName)) {
                    targetCard = card;
                    break;
                }
            }
            
            if (targetCard) {
                // Hide the card body
                const cardBody = targetCard.querySelector('.card-body');
                if (cardBody) {
                    cardBody.style.display = 'none';
                    cardBody.innerHTML = '';
                }
                
                // Reset the View Records button
                const viewButton = targetCard.querySelector('.btn[onclick*="hideTableRecords"]');
                if (viewButton) {
                    viewButton.innerHTML = '<i class="fas fa-eye"></i> View Records';
                    viewButton.onclick = () => loadTableRecords(tableName);
                }
            }
        }

        // Load More Records Function
        async function loadMoreRecords(tableName) {
            if (!authToken) return;
            
            // Find the table card container
            const tableCards = document.querySelectorAll('.card');
            let targetCard = null;
            
            for (const card of tableCards) {
                const cardTitle = card.querySelector('h6');
                if (cardTitle && cardTitle.textContent.includes(tableName)) {
                    targetCard = card;
                    break;
                }
            }
            
            if (!targetCard) {
                console.error('Could not find table card for:', tableName);
                return;
            }
            
            const tableView = targetCard.querySelector('.table-records-view');
            const tableBody = tableView.querySelector('.database-table tbody');
            const loadMoreButton = tableView.querySelector('button[onclick*="loadMoreRecords"]');
            const recordsInfo = tableView.querySelector('.text-muted');
            
            if (!tableBody || !loadMoreButton) {
                console.error('Required table elements not found for:', tableName);
                return;
            }
            
            // Get current offset (number of records already loaded)
            const currentRecords = tableBody.querySelectorAll('tr').length;
            const offset = currentRecords;
            
            try {
                // Show loading state
                const originalText = loadMoreButton.innerHTML;
                loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                loadMoreButton.disabled = true;
                
                console.log(`Loading more records for ${tableName}, offset: ${offset}`);
                
                const response = await fetch(`/api/v1/setup/database/table/${tableName}/records?offset=${offset}&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Loaded ${data.records.length} more records for ${tableName}`);
                    
                    if (data.records && data.records.length > 0) {
                        // Get column names from first record
                        const columns = Object.keys(data.records[0]);
                        
                        // Add new records to the table
                        const newRows = data.records.map(record => `
                            <tr>
                                ${columns.map(col => `<td title="${record[col] || 'null'}">${record[col] || '<span class="text-muted">null</span>'}</td>`).join('')}
                            </tr>
                        `).join('');
                        
                        tableBody.insertAdjacentHTML('beforeend', newRows);
                        
                        // Update the records info
                        const totalShown = currentRecords + data.records.length;
                        if (recordsInfo) {
                            recordsInfo.textContent = `Showing ${totalShown} of ${data.total_count} records`;
                        }
                        
                        // Hide button if no more records
                        if (!data.has_more) {
                            loadMoreButton.style.display = 'none';
                        }
                        
                        showAlert('success', `Loaded ${data.records.length} more records from ${tableName}`);
                    }
                } else {
                    const errorData = await response.json();
                    showAlert('danger', `Failed to load more records: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error loading more records:', error);
                showAlert('danger', 'Error loading more records');
            } finally {
                // Restore button state
                loadMoreButton.innerHTML = '<i class="fas fa-plus"></i> Load More Records';
                loadMoreButton.disabled = false;
            }
        }

        // Delete All Records Function
        async function deleteAllRecords(tableName) {
            if (!authToken) return;
            
            // Show confirmation dialog
            const confirmMessage = `⚠️ WARNING: This will permanently delete ALL records from the "${tableName}" table.\n\nThis action cannot be undone!\n\nAre you sure you want to continue?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Second confirmation for extra safety
            const secondConfirm = `🚨 FINAL CONFIRMATION\n\nYou are about to delete ALL ${tableName} records.\n\nType "DELETE" to confirm:`;
            const userInput = prompt(secondConfirm);
            
            if (userInput !== 'DELETE') {
                showAlert('info', 'Delete operation cancelled');
                return;
            }
            
            try {
                console.log(`🗑️ Deleting all records from table: ${tableName}`);
                
                const response = await fetch(`/api/v1/setup/database/table/${tableName}/delete-all`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('success', `Successfully deleted ${result.deleted_count} records from ${tableName}`);
                    
                    // Refresh the database info to update the UI
                    refreshDatabaseInfo();
                    
                    // Hide any open table records view
                    hideTableRecords(tableName);
                } else {
                    const errorData = await response.json();
                    showAlert('danger', `Failed to delete records: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting records:', error);
                showAlert('danger', 'Error deleting records from table');
            }
        }

        // User-Property Management Functions
        async function loadUsersAndProperties() {
            if (!authToken) {
                console.error('loadUsersAndProperties: No authToken available');
                return;
            }
            
            console.log('loadUsersAndProperties called - loading dropdowns only');
            console.log('authToken available:', !!authToken);
            
            try {
                // Load users and properties for the form dropdowns
                console.log('Starting to load users and properties...');
                await Promise.all([
                    loadUsersForAssignment(),
                    loadPropertiesForAssignment()
                ]);
                
                console.log('Users and properties loaded for dropdowns');
            } catch (error) {
                console.error('Error loading users and properties for dropdowns:', error);
            }
        }

        async function refreshUserProperties() {
            if (!authToken) return;
            
            console.log('refreshUserProperties called - refreshing assignments only');
            
            try {
                // Load current assignments only
                console.log('Loading current assignments...');
                const response = await fetch('/api/v1/user-properties/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const assignments = await response.json();
                    console.log('Assignments received:', assignments);
                    displayUserPropertyAssignments(assignments);
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showAlert('danger', 'Failed to load user-property assignments');
                }
            } catch (error) {
                console.error('Error loading user properties:', error);
                showAlert('danger', 'Error loading user-property assignments');
            }
        }

        async function loadInitialAssignments() {
            if (!authToken) return;

            try {
                console.log('Loading initial user-property assignments...');
                const response = await fetch('/api/v1/user-properties/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const assignments = await response.json();
                    console.log('Initial assignments received:', assignments);
                    displayUserPropertyAssignments(assignments);
                } else {
                    const errorText = await response.text();
                    console.error('Error loading initial assignments:', errorText);
                    showAlert('danger', 'Failed to load initial user-property assignments');
                }
            } catch (error) {
                console.error('Error loading initial assignments:', error);
                showAlert('danger', 'Error loading initial user-property assignments');
            }
        }

        async function loadUsersForAssignment() {
            try {
                console.log('loadUsersForAssignment called');
                console.log('authToken available:', !!authToken);
                
                if (!authToken) {
                    console.error('No authToken available for loading users');
                    return;
                }
                
                const response = await fetch('/api/v1/auth/users', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Users response status:', response.status);
                console.log('Users response ok:', response.ok);
                
                if (response.ok) {
                    const users = await response.json();
                    console.log('Users received:', users);
                    console.log('Number of users:', users ? users.length : 'undefined');
                    populateUserSelect(users);
                } else {
                    const errorText = await response.text();
                    console.error('Users error response:', errorText);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadPropertiesForAssignment() {
            try {
                console.log('loadPropertiesForAssignment called');
                const response = await fetch('/api/v1/properties/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('Properties response status:', response.status);
                console.log('Properties response ok:', response.ok);
                
                if (response.ok) {
                    const properties = await response.json();
                    console.log('Properties received:', properties);
                    
                    // Store properties globally like the working implementation
                    window.availableProperties = properties;
                    console.log('Properties stored globally:', window.availableProperties);
                    
                    populatePropertySelect(properties);
                } else {
                    const errorText = await response.text();
                    console.error('Properties error response:', errorText);
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }

        function populateUserSelect(users) {
            console.log('populateUserSelect called with users:', users);
            const userSelect = document.getElementById('assign-user');
            console.log('User select element found:', userSelect);
            
            if (!userSelect) {
                console.error('User select element not found!');
                return;
            }
            
            console.log('Clearing and populating user select...');
            userSelect.innerHTML = '<option value="">Select User</option>';
            
            if (users && users.length > 0) {
                users.forEach(user => {
                    console.log('Adding user option:', user);
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username}${user.email ? ` (${user.email})` : ''}`;
                    userSelect.appendChild(option);
                });
                console.log('User select populated with', users.length, 'users');
            } else {
                console.log('No users to populate');
            }
        }

        function populatePropertySelect(properties) {
            const propertySelect = document.getElementById('assign-property');
            if (!propertySelect) return;
            
            propertySelect.innerHTML = '<option value="">Select Property</option>';
            properties.forEach(property => {
                const option = document.createElement('option');
                option.value = property.id;
                option.textContent = `${property.property_name} (${property.property_code})`;
                propertySelect.appendChild(option);
            });
        }

        function displayUserPropertyAssignments(assignments) {
            const container = document.getElementById('user-properties-list');
            
            if (!assignments || assignments.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-2x mb-3"></i>
                        <p>No user-property assignments found</p>
                    </div>
                `;
                return;
            }
            
            const assignmentsHtml = assignments.map(assignment => `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${assignment.user.username}</strong> → 
                                <strong>${assignment.property.property_name}</strong>
                                ${assignment.is_primary ? '<span class="badge bg-primary ms-2">Primary</span>' : ''}
                            </div>
                            <div>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="removeUserPropertyAssignment(${assignment.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = assignmentsHtml;
        }

        // Event Listeners
        document.getElementById('show-active-only').addEventListener('change', function() {
            // Re-render properties list when filter changes
            // This will be handled by the existing properties data
        });

        // Add form submission handler for property assignment
        document.addEventListener('DOMContentLoaded', function() {
            const assignForm = document.getElementById('assign-property-form');
            if (assignForm) {
                assignForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await assignPropertyToUser();
                });
            }
        });

        async function assignPropertyToUser() {
            if (!authToken) return;
            
            const userId = document.getElementById('assign-user').value;
            const propertyId = document.getElementById('assign-property').value;
            const isPrimary = document.getElementById('assign-primary').checked;
            
            if (!userId || !propertyId) {
                showAlert('danger', 'Please select both user and property');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/user-properties/assign', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        property_id: parseInt(propertyId),
                        is_primary: isPrimary
                    })
                });
                
                if (response.ok) {
                    showAlert('success', 'Property assigned successfully!');
                    document.getElementById('assign-property-form').reset();
                    refreshUserProperties();
                } else {
                    const error = await response.json();
                    showAlert('danger', `Failed to assign property: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error assigning property:', error);
                showAlert('danger', 'Error assigning property');
            }
        }

        async function removeUserPropertyAssignment(assignmentId) {
            if (!authToken) return;
            
            if (!confirm('Are you sure you want to remove this property assignment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/user-properties/${assignmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showAlert('success', 'Property assignment removed successfully!');
                    refreshUserProperties();
                } else {
                    const error = await response.json();
                    showAlert('danger', `Failed to remove assignment: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error removing assignment:', error);
                showAlert('danger', 'Error removing property assignment');
            }
        }

        // Utility Functions
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }
        
        // Environment Configuration Functions
        let currentEnvironmentVariables = {};
        
        function validateEnvironmentVariables(variables) {
            const errors = [];
            
            // Validation rules (client-side mirror of backend)
            const rules = {
                'AGENT_ID': { required: true, type: 'numeric', minLength: 1 },
                'AGENT_PASSWORD': { required: true, type: 'string', minLength: 8 },
                'CLIENT_ID': { required: true, type: 'numeric', minLength: 1 },
                'CLIENT_PASSWORD': { required: true, type: 'string', minLength: 8 },
                'DB_PORT': { type: 'port' },
                'WEB_APP_PORT': { type: 'port' },
                'SMTP_PORT': { type: 'port' },
                'SENDER_EMAIL': { type: 'email' },
                'TEST_RECIPIENT': { type: 'email' },
                'CONSOLIDATED_EMAIL_RECIPIENT': { type: 'email' },
                'PROPERTY_REFRESH_INTERVAL_HOURS': { type: 'positiveInteger' },

                'LOG_LEVEL': { type: 'choice', choices: ['DEBUG', 'INFO', 'WARNING', 'ERROR'] }
            };
            
            // Email validation regex
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            
            for (const [key, value] of Object.entries(variables)) {
                if (rules[key]) {
                    const rule = rules[key];
                    
                    // Check required fields
                    if (rule.required && !value.trim()) {
                        errors.push(`${key} is required`);
                        continue;
                    }
                    
                    // Skip validation for empty optional fields
                    if (!value.trim()) continue;
                    
                    // Type validation
                    if (rule.type === 'numeric') {
                        if (isNaN(value) || !Number.isInteger(Number(value))) {
                            errors.push(`${key} must be a number`);
                        }
                    } else if (rule.type === 'port') {
                        const port = parseInt(value);
                        if (isNaN(port) || port < 1 || port > 65535) {
                            errors.push(`${key} must be a valid port (1-65535)`);
                        }
                    } else if (rule.type === 'positiveInteger') {
                        const num = parseInt(value);
                        if (isNaN(num) || num <= 0) {
                            errors.push(`${key} must be a positive integer`);
                        }
                    } else if (rule.type === 'email') {
                        if (!emailRegex.test(value)) {
                            errors.push(`${key} must be a valid email address`);
                        }
                    } else if (rule.type === 'choice') {
                        if (!rule.choices.includes(value)) {
                            errors.push(`${key} must be one of: ${rule.choices.join(', ')}`);
                        }
                    }
                    
                    // Length validation
                    if (rule.minLength && value.length < rule.minLength) {
                        errors.push(`${key} must be at least ${rule.minLength} characters long`);
                    }
                }
                
                // Security checks
                const dangerousPatterns = [
                    { pattern: /[;&|`$()]/, description: 'contains shell injection characters' },
                    { pattern: /<script/i, description: 'contains script tags' },
                    { pattern: /javascript:/i, description: 'contains javascript protocol' },
                    { pattern: /file:\/\//i, description: 'contains file protocol' },
                    { pattern: /\.\.\//g, description: 'contains directory traversal' }
                ];
                
                for (const { pattern, description } of dangerousPatterns) {
                    if (pattern.test(value)) {
                        errors.push(`${key} ${description}`);
                    }
                }
            }
            
            return errors;
        }
        
        async function loadEnvironmentVariables() {
            if (!authToken) return;
            
            try {
                console.log('Loading environment variables...');
                const response = await fetch('/api/v1/setup/environment', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Environment variables loaded:', data);
                    currentEnvironmentVariables = data.variables;
                    displayEnvironmentForm(data.variables, data.file_exists, data.file_path);
                } else {
                    const error = await response.json();
                    showAlert('danger', `Failed to load environment variables: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error loading environment variables:', error);
                showAlert('danger', 'Error loading environment variables');
            }
        }
        
        function displayEnvironmentForm(variables, fileExists, filePath) {
            const container = document.getElementById('environment-form');
            
            // Define variable categories and their descriptions
            const categories = [
                {
                    title: 'RMS API Credentials',
                    description: 'Required credentials for RMS API access (both CLI and web app)',
                    critical: true,
                    variables: [
                        { key: 'AGENT_ID', label: 'Agent ID', type: 'text', required: true },
                        { key: 'AGENT_PASSWORD', label: 'Agent Password', type: 'password', required: true },
                        { key: 'CLIENT_ID', label: 'Client ID', type: 'text', required: true },
                        { key: 'CLIENT_PASSWORD', label: 'Client Password', type: 'password', required: true }
                    ]
                },
                {
                    title: 'Database Configuration',
                    description: 'PostgreSQL database settings for the web application',
                    critical: false,
                    variables: [
                        { key: 'DB_HOST', label: 'Database Host', type: 'text', placeholder: 'localhost' },
                        { key: 'DB_PORT', label: 'Database Port', type: 'number', placeholder: '5432' },
                        { key: 'DB_NAME', label: 'Database Name', type: 'text', placeholder: 'defrag_db' },
                        { key: 'DB_USER', label: 'Database User', type: 'text', placeholder: 'defrag_user' },
                        { key: 'DB_PASSWORD', label: 'Database Password', type: 'password', placeholder: 'DefragDB2024!' }
                    ]
                },
                {
                    title: 'Web Application',
                    description: 'Web server settings (technical settings use optimal defaults)',
                    critical: false,
                    variables: [
                        { key: 'WEB_APP_PORT', label: 'Web App Port', type: 'text', value: '8000', readonly: true },
                        { key: 'PROPERTY_REFRESH_INTERVAL_HOURS', label: 'Property Refresh Interval (Hours)', type: 'number', placeholder: '1' }
                    ]
                },
                {
                    title: 'Analysis Configuration',
                    description: 'Settings for the booking chart defragmentation analysis',
                    critical: false,
                    variables: [
                        { key: 'TARGET_PROPERTIES', label: 'Target Properties', type: 'text', placeholder: 'ALL or comma-separated list (e.g., CALI,WHED,WKAR)' },
                        { key: 'USE_TRAINING_DB', label: 'Use Training Database', type: 'select', options: ['true', 'false'], note: 'Defaults to training for safety' }
                    ]
                },
                {
                    title: 'Email Configuration',
                    description: 'Email notification settings',
                    critical: false,
                    variables: [
                        { key: 'ENABLE_EMAILS', label: 'Enable Emails', type: 'select', options: ['false', 'true'] },
                        { key: 'SEND_CONSOLIDATED_EMAIL', label: 'Send Consolidated Email', type: 'select', options: ['false', 'true'] },
                        { key: 'CONSOLIDATED_EMAIL_RECIPIENT', label: 'Consolidated Email Recipient', type: 'email', placeholder: 'operations@discoveryparks.com.au' }
                    ]
                },
                {
                    title: 'SMTP Configuration',
                    description: 'SMTP server settings for sending emails',
                    critical: false,
                    variables: [
                        { key: 'SMTP_SERVER', label: 'SMTP Server', type: 'text', placeholder: 'smtp.gmail.com' },
                        { key: 'SMTP_PORT', label: 'SMTP Port', type: 'number', placeholder: '587' },
                        { key: 'SENDER_EMAIL', label: 'Sender Email', type: 'email', placeholder: 'your_email@domain.com' },
                        { key: 'SENDER_DISPLAY_NAME', label: 'Sender Display Name', type: 'text', placeholder: 'DHP Defragmentation System' },
                        { key: 'APP_PASSWORD', label: 'App Password', type: 'password', placeholder: 'Gmail app password' },
                        { key: 'TEST_RECIPIENT', label: 'Test Recipient', type: 'email', placeholder: 'test@domain.com' }
                    ]
                },
                {
                    title: 'Scheduling & Automation',
                    description: 'Cron scheduling and automation settings',
                    critical: false,
                    variables: [
                        { key: 'CRON_SCHEDULE', label: 'Cron Schedule', type: 'text', placeholder: '0 2 * * * (daily at 2 AM)' },
                        { key: 'ENABLE_CRON', label: 'Enable Cron', type: 'select', options: ['true', 'false'] }
                    ]
                },

                {
                    title: 'ChatGPT Integration',
                    description: 'OpenAI ChatGPT API configuration for move explanation features',
                    critical: false,
                    variables: [
                        { key: 'OPENAI_API_KEY', label: 'OpenAI API Key', type: 'password', placeholder: 'sk-...' }
                    ]
                },
                {
                    title: 'System Configuration',
                    description: 'System settings (automatically configured with optimal defaults)',
                    critical: false,
                    readonly: true,
                    variables: [
                        { key: 'TZ', label: 'Timezone', type: 'text', value: 'Australia/Sydney', readonly: true },
                        { key: 'LOG_LEVEL', label: 'Log Level', type: 'text', value: 'INFO', readonly: true },
                        { key: 'OUTPUT_DIR', label: 'Output Directory', type: 'text', value: '/app/output', readonly: true },

                    ]
                }
            ];
            
            let formHtml = `
                <div class="mb-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Environment File:</strong> ${filePath} ${fileExists ? '(exists)' : '(will be created)'}
                    </div>
                </div>
                <form id="environment-variables-form">
            `;
            
            categories.forEach(category => {
                const criticalBadge = category.critical ? '<span class="badge bg-danger ms-2">Required</span>' : '';
                
                formHtml += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-${category.critical ? 'exclamation-triangle' : 'cog'} me-2"></i>
                                ${category.title}${criticalBadge}
                            </h6>
                            <small class="text-muted">${category.description}</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                
                category.variables.forEach(variable => {
                    const value = variables[variable.key] || '';
                    const requiredAttr = variable.required ? 'required' : '';
                    const colClass = category.critical ? 'col-md-6' : 'col-md-4';
                    
                    formHtml += `
                        <div class="${colClass} mb-3">
                            <label for="${variable.key}" class="form-label">
                                ${variable.label}
                                ${variable.required ? '<span class="text-danger">*</span>' : ''}
                            </label>
                    `;
                    
                    if (variable.type === 'select') {
                        const readonlyAttr = variable.readonly ? 'disabled' : '';
                        formHtml += `
                            <select class="form-select" id="${variable.key}" name="${variable.key}" ${requiredAttr} ${readonlyAttr}>
                                ${variable.options.map(option => 
                                    `<option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>`
                                ).join('')}
                            </select>
                        `;
                    } else {
                        const readonlyAttr = variable.readonly ? 'readonly' : '';
                        const displayValue = variable.readonly && variable.value ? variable.value : value;
                        formHtml += `
                            <input type="${variable.type}" 
                                   class="form-control" 
                                   id="${variable.key}" 
                                   name="${variable.key}" 
                                   value="${displayValue}" 
                                   placeholder="${variable.placeholder || ''}"
                                   ${requiredAttr}
                                   ${readonlyAttr}>
                        `;
                    }
                    
                    // Add note if specified
                    if (variable.note) {
                        formHtml += `<small class="form-text text-muted">${variable.note}</small>`;
                    }
                    
                    formHtml += '</div>';
                });
                
                formHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            formHtml += '</form>';
            
            container.innerHTML = formHtml;
        }
        
        async function saveEnvironmentVariables() {
            if (!authToken) return;
            
            const form = document.getElementById('environment-variables-form');
            if (!form) {
                showAlert('danger', 'Environment form not found');
                return;
            }
            
            try {
                // Collect all form data
                const formData = new FormData(form);
                const variables = {};
                
                for (const [key, value] of formData.entries()) {
                    variables[key] = value.trim();
                }
                
                // Validate required fields
                const requiredFields = ['AGENT_ID', 'AGENT_PASSWORD', 'CLIENT_ID', 'CLIENT_PASSWORD'];
                const missingFields = requiredFields.filter(field => !variables[field]);
                
                if (missingFields.length > 0) {
                    showAlert('danger', `Please fill in required fields: ${missingFields.join(', ')}`);
                    return;
                }
                
                // Additional client-side validation
                const validationErrors = validateEnvironmentVariables(variables);
                if (validationErrors.length > 0) {
                    showAlert('danger', `Validation errors: ${validationErrors.join(', ')}`);
                    return;
                }
                
                console.log('Saving environment variables:', variables);
                
                const response = await fetch('/api/v1/setup/environment', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ variables })
                });
                
                if (response.ok) {
                    // Be robust to empty/partial responses during restart
                    let result = null;
                    try {
                        const raw = await response.text();
                        result = raw ? JSON.parse(raw) : null;
                    } catch (_) { result = null; }
                    console.log('Environment variables saved:', result);
                    if (result && result.variables) {
                        currentEnvironmentVariables = result.variables;
                    }
                    
                    if (result && result.restart_initiated) {
                        showAlert('success', 'Environment configuration saved successfully!');
                        showAlert('info', 'Application is restarting automatically to apply changes. Please wait a moment...');
                        
                        // Wait a few seconds then refresh the page to reconnect
                        setTimeout(() => {
                            showAlert('info', 'Refreshing page to reconnect...');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        }, 8000);
                    } else {
                        showAlert('success', 'Environment configuration saved successfully!');
                        showAlert('warning', 'Please restart the application to apply all configuration changes.');
                    }
                } else {
                    const error = await response.json();
                    showAlert('danger', `Failed to save configuration: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error saving environment variables:', error);
                showAlert('danger', 'Error saving environment configuration');
            }
        }
        
        async function testRmsConnectionFromConfig() {
            if (!authToken) {
                showAlert('danger', 'Authentication required');
                return;
            }
            
            const form = document.getElementById('environment-variables-form');
            if (!form) {
                showAlert('danger', 'Environment form not found. Please load the configuration first.');
                return;
            }
            
            try {
                // Collect form data for testing
                const formData = new FormData(form);
                const variables = {};
                
                for (const [key, value] of formData.entries()) {
                    variables[key] = value.trim();
                }
                
                // Validate required RMS credentials
                const requiredFields = ['AGENT_ID', 'AGENT_PASSWORD', 'CLIENT_ID', 'CLIENT_PASSWORD'];
                const missingFields = requiredFields.filter(field => !variables[field]);
                
                if (missingFields.length > 0) {
                    showAlert('warning', `Please fill in the following RMS credentials before testing: ${missingFields.join(', ')}`);
                    return;
                }
                
                // Test the connection
                showAlert('info', 'Testing RMS API connection...');
                
                const response = await fetch('/api/v1/setup/test-rms-connection', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ variables })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.success) {
                        showAlert('success', result.message);
                        
                        // Show detailed results if available
                        if (result.details) {
                            let detailsMessage = '<div class="mt-2 small">';
                            for (const [key, value] of Object.entries(result.details)) {
                                if (key !== 'possible_causes' && key !== 'credentials_check') {
                                    detailsMessage += `<strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}<br>`;
                                }
                            }
                            detailsMessage += '</div>';
                            showAlert('info', detailsMessage);
                        }
                    } else {
                        showAlert('danger', result.message);
                        
                        // Show error details if available
                        if (result.details) {
                            let errorMessage = '';
                            if (result.details.error) {
                                errorMessage += `<div class="mt-1"><strong>Error:</strong> ${result.details.error}</div>`;
                            }
                            if (result.details.possible_causes && Array.isArray(result.details.possible_causes)) {
                                errorMessage += '<div class="mt-1"><strong>Possible causes:</strong><ul class="mb-0 ms-3">';
                                result.details.possible_causes.forEach(cause => {
                                    errorMessage += `<li>${cause}</li>`;
                                });
                                errorMessage += '</ul></div>';
                            }
                            if (errorMessage) {
                                showAlert('warning', errorMessage);
                            }
                        }
                    }
                } else {
                    showAlert('danger', result.message || 'RMS API test failed');
                }
                
            } catch (error) {
                console.error('Error testing RMS connection:', error);
                showAlert('danger', `Error testing RMS connection: ${error.message}`);
            }
        }
        
        async function testChatGptConnectionFromConfig() {
            if (!authToken) {
                showAlert('danger', 'Authentication required');
                return;
            }
            
            const form = document.getElementById('environment-variables-form');
            if (!form) {
                showAlert('danger', 'Environment form not found. Please load the configuration first.');
                return;
            }
            
            try {
                // Collect form data for testing
                const formData = new FormData(form);
                const variables = {};
                
                for (const [key, value] of formData.entries()) {
                    variables[key] = value.trim();
                }
                
                // Validate ChatGPT API key
                if (!variables['OPENAI_API_KEY']) {
                    showAlert('warning', 'Please enter an OpenAI API key before testing.');
                    return;
                }
                
                if (!variables['OPENAI_API_KEY'].startsWith('sk-')) {
                    showAlert('warning', 'OpenAI API key should start with "sk-". Please check your API key.');
                    return;
                }
                
                // Test the connection
                showAlert('info', 'Testing ChatGPT API connection...');
                
                const response = await fetch('/api/v1/setup/test-chatgpt-connection', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ variables })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.success) {
                        showAlert('success', result.message);
                        
                        // Show detailed results if available
                        if (result.details) {
                            let detailsMessage = '<div class="mt-2 small">';
                            for (const [key, value] of Object.entries(result.details)) {
                                detailsMessage += `<strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}<br>`;
                            }
                            detailsMessage += '</div>';
                            showAlert('info', detailsMessage);
                        }
                    } else {
                        showAlert('danger', result.message);
                        
                        // Show error details if available
                        if (result.details && result.details.error) {
                            showAlert('warning', `<div class="mt-1"><strong>Error:</strong> ${result.details.error}</div>`);
                        }
                    }
                } else {
                    showAlert('danger', result.message || 'ChatGPT API test failed');
                }
                
            } catch (error) {
                console.error('Error testing ChatGPT connection:', error);
                showAlert('danger', `Error testing ChatGPT connection: ${error.message}`);
            }
        }

        let usersCache = [];

        async function loadUsers() {
          if (!authToken) return;
          const el = document.getElementById('users-list');
          el.innerHTML = '<div class="text-muted">Loading users...</div>';
          try{
            const res = await fetch('/api/v1/auth/users', { headers: { 'Authorization': `Bearer ${authToken}` }});
            if(!res.ok){ el.innerHTML = '<div class="text-danger">Failed to load users</div>'; return; }
            usersCache = await res.json();
            if(!Array.isArray(usersCache) || usersCache.length === 0){
              el.innerHTML = '<div class="text-muted">No users yet. Click "Add User".</div>';
              return;
            }
            const rows = usersCache.map(u => `
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <strong>${u.username}</strong> <span class="text-muted">${u.email}</span>
                  ${u.is_admin ? '<span class="badge bg-info ms-2">Admin</span>' : ''}
                  ${u.is_active ? '' : '<span class="badge bg-secondary ms-2">Inactive</span>'}
                </div>
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary" onclick="editUser(${u.id})"><i class="fas fa-pen"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                </div>
              </div>`).join('');
            el.innerHTML = rows;
          }catch(e){ el.innerHTML = '<div class="text-danger">Error loading users</div>'; }
        }

        function openUserModal(){
          resetUserForm();
          document.getElementById('userModalTitle').textContent = 'Add User';
          const modal = new bootstrap.Modal(document.getElementById('userModal'));
          renderPropertySelector();
          modal.show();
        }

        async function editUser(userId){
          const u = usersCache.find(x => x.id === userId);
          if(!u) return;
          resetUserForm();
          document.getElementById('userModalTitle').textContent = 'Edit User';
          document.getElementById('user-id').value = u.id;
          document.getElementById('user-username').value = u.username;
          document.getElementById('user-email').value = u.email;
          document.getElementById('user-first-name').value = u.first_name || '';
          document.getElementById('user-last-name').value = u.last_name || '';
          document.getElementById('user-is-admin').checked = !!u.is_admin;
          document.getElementById('user-is-active').checked = !!u.is_active;
          await renderPropertySelector(u);
          const modal = new bootstrap.Modal(document.getElementById('userModal'));
          modal.show();
        }

        function resetUserForm(){
          document.getElementById('user-form').reset();
          document.getElementById('user-id').value = '';
          document.getElementById('user-password').value = '';
        }

        async function renderPropertySelector(user){
          // Load available properties list if not already
          if (!window.availableProperties) {
            try{
              const res = await fetch('/api/v1/properties/', { headers: { 'Authorization': `Bearer ${authToken}` }});
              if(res.ok){ window.availableProperties = await res.json(); }
            }catch(e){}
          }
          const container = document.getElementById('user-properties-selector');
          const props = window.availableProperties || [];
          if(props.length === 0){ container.innerHTML = '<div class="text-muted">No properties available</div>'; return; }
          // Fetch current assignments for edit
          let assigned = [];
          if(user && user.id){
            try{
              const res = await fetch(`/api/v1/user-properties/user/${user.id}/properties`, { headers: { 'Authorization': `Bearer ${authToken}` }});
              if(res.ok){ assigned = await res.json(); }
            }catch(e){}
          }
          const assignedIds = new Set(assigned.map(a => a.property_id));
          const primaryId = (assigned.find(a => a.is_primary) || {}).property_id;
          container.innerHTML = props.map(p => `
            <div class="col-md-4">
              <div class="border rounded p-2 h-100">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="prop-${p.id}" ${assignedIds.has(p.id) ? 'checked' : ''}>
                  <label class="form-check-label" for="prop-${p.id}"><strong>${p.property_code}</strong> <span class="text-muted">${p.property_name}</span></label>
                </div>
                <div class="form-check ms-4 mt-1">
                  <input class="form-check-input" name="primary-prop" type="radio" id="prop-prim-${p.id}" ${primaryId===p.id ? 'checked' : ''} ${assignedIds.has(p.id)? '' : 'disabled'}>
                  <label class="form-check-label" for="prop-prim-${p.id}">Primary</label>
                </div>
              </div>
            </div>`).join('');
          // Enable/disable primary radio when checkbox toggles
          props.forEach(p => {
            const cb = document.getElementById(`prop-${p.id}`);
            const rb = document.getElementById(`prop-prim-${p.id}`);
            if(cb && rb){
              cb.addEventListener('change', () => { rb.disabled = !cb.checked; if(!cb.checked) rb.checked = false; });
            }
          });
        }

        async function saveUser(){
          const id = document.getElementById('user-id').value;
          const payload = {
            username: document.getElementById('user-username').value.trim(),
            email: document.getElementById('user-email').value.trim(),
            first_name: document.getElementById('user-first-name').value.trim() || null,
            last_name: document.getElementById('user-last-name').value.trim() || null,
            is_admin: document.getElementById('user-is-admin').checked,
            is_active: document.getElementById('user-is-active').checked
          };
          console.debug('saveUser payload', { id, payload });
          const password = document.getElementById('user-password').value;
          const isEdit = !!id;
          // Client-side password check for create only
          if(!isEdit && password){
            const upper = /[A-Z]/.test(password);
            const special = /[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(password);
            if(password.length < 8 || !upper || !special){
              showAlert('danger','Password must be at least 8 chars with 1 uppercase and 1 special character.');
              return;
            }
          }
          try{
            let res;
            if(isEdit){
              res = await fetch(`/api/v1/auth/users/${id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            } else {
              if(!payload.username){ showAlert('danger','Username is required'); return; }
              const createBody = {
                username: payload.username,
                email: payload.email,
                password: password || generateTempPassword(),
                first_name: payload.first_name,
                last_name: payload.last_name,
                is_admin: payload.is_admin
              };
              console.debug('create user body', createBody);
              res = await fetch('/api/v1/auth/users', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(createBody) });
            }
            console.debug('saveUser response status', res && res.status);
            if(!res || !res.ok){
              try { const err = await res.json(); console.debug('saveUser error json', err); showAlert('danger', `Failed to save user: ${err.detail || res.statusText}`); } catch(e) { console.debug('saveUser error text', e); showAlert('danger','Failed to save user'); }
              return; }
            const saved = await res.json();
            console.debug('user saved', saved);
            // If avatar selected, upload now
            try{
              const fileEl = document.getElementById('user-avatar-file');
              if(fileEl && fileEl.files && fileEl.files[0]){
                const fd = new FormData();
                fd.append('file', fileEl.files[0]);
                const upRes = await fetch(`/api/v1/auth/users/${saved.id}/avatar`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` }, body: fd });
                if(!upRes.ok){ showAlert('warning', 'User saved, but avatar upload failed'); }
              }
            }catch(_){ }
            // Sync property assignments if not admin
            if(!payload.is_admin){
              await syncUserProperties(saved.id);
            }
            // Close modal and refresh list
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            await loadUsers();
            showAlert('success', 'User saved');
            // If current user updated self, refresh header to show avatar immediately
            try{
              const me = await fetch('/api/v1/auth/me', { headers: { 'Authorization': `Bearer ${authToken}` } });
              if(me.ok){
                const meJson = await me.json();
                if(saved.id === meJson.id && meJson.avatar_url){
                  const avatarEl = document.getElementById('user-avatar');
                  const iconEl = document.getElementById('user-icon');
                  if(avatarEl){ avatarEl.src = meJson.avatar_url; avatarEl.classList.remove('d-none'); }
                  if(iconEl){ iconEl.classList.add('d-none'); }
                }
              }
            }catch(_){ }
          }catch(e){ showAlert('danger', 'Error saving user'); }
        }

        function generateTempPassword(){
          return 'Temp' + Math.random().toString(36).slice(2, 10) + '!A1';
        }

        async function syncUserProperties(userId){
          const props = window.availableProperties || [];
          // Fetch current assignments
          let current = [];
          try{ const res = await fetch(`/api/v1/user-properties/user/${userId}/properties`, { headers: { 'Authorization': `Bearer ${authToken}` }}); if(res.ok){ current = await res.json(); } }catch(e){}
          const currentIds = new Set(current.map(a => a.property_id));
          const selectedIds = [];
          let selectedPrimary = null;
          props.forEach(p => {
            const cb = document.getElementById(`prop-${p.id}`);
            const rb = document.getElementById(`prop-prim-${p.id}`);
            if(cb && cb.checked){ selectedIds.push(p.id); if(rb && rb.checked){ selectedPrimary = p.id; } }
          });
          // Assign newly selected
          for(const pid of selectedIds){
            if(!currentIds.has(pid)){
              await fetch('/api/v1/user-properties/assign', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, property_id: pid, is_primary: selectedPrimary === pid }) });
            }
          }
          // Update primary if changed
          if(selectedPrimary){
            const primaryAssignment = current.find(a => a.property_id === selectedPrimary);
            if(primaryAssignment && !primaryAssignment.is_primary){
              await fetch(`/api/v1/user-properties/${primaryAssignment.id}`, { method: 'PUT', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_primary: true }) });
            }
          }
          // Remove deselected
          for(const a of current){
            if(!selectedIds.includes(a.property_id)){
              await fetch(`/api/v1/user-properties/${a.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` }});
            }
          }
        }

        async function deleteUser(userId){
          if(!confirm('Delete this user?')) return;
          try{
            const res = await fetch(`/api/v1/auth/users/${userId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` }});
            if(res.ok){ await loadUsers(); showAlert('success', 'User deleted'); } else { showAlert('danger', 'Failed to delete'); }
          }catch(e){ showAlert('danger', 'Error deleting user'); }
        }

        // Load users when admin section shows
        function loadInitialAssignments(){
          if (!authToken) return;
          refreshUserProperties();
          loadUsers();
        }
    </script>
    {% include 'components/footer.html' %}
</body>
</html>